<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ - –ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∞ –ø–∞–Ω–µ–ª—å</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro@2.9.6/build/vanilla-calendar.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: rgba(255, 255, 255, 0.85);
            --blur-effect: backdrop-filter: blur(10px);
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --text-color: #2c2c2c;
            --accent-color: #007aff;
            --transition-speed: 0.3s;
        }

        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Inter', sans-serif; color: var(--text-color); background-color: #eef1f4; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        
        #top-panel { position: absolute; top: 0; left: 0; right: 0; z-index: 1000; background: var(--bg-color); -webkit-backdrop-filter: var(--blur-effect); backdrop-filter: var(--blur-effect); border-bottom: 1px solid var(--border-color); box-shadow: 0 4px 20px var(--shadow-color); }
        .panel-header { padding: 0 20px; height: 55px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .panel-header h2 { margin: 0; font-size: 18px; }
        #panel-toggle-icon { transition: transform var(--transition-speed) ease; }
        #top-panel.collapsed #panel-toggle-icon { transform: rotate(-180deg); }
        
        .panel-content { max-height: 0; overflow: hidden; transition: max-height var(--transition-speed) ease-in-out; display: flex; padding: 0 10px; border-top: 1px solid transparent; }
        #top-panel:not(.collapsed) .panel-content { max-height: 50vh; padding: 10px; border-top-color: var(--border-color); }
        
        .panel-column { padding: 0 10px; height: calc(50vh - 20px); display: flex; flex-direction: column; }
        .panel-column h3 { margin: 0 0 10px 0; font-size: 16px; font-weight: 600; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); }
        #calendar-column { flex: 0 0 300px; }
        #events-column { flex: 1 1 40%; overflow-y: auto; }
        #layers-column { flex: 1 1 30%; }

        #action-buttons { display: flex; gap: 15px; }
        .action-button { background: none; border: none; font-size: 18px; cursor: pointer; color: var(--text-color); padding: 5px; position: relative; }
        
        /* üé® –°—Ç–∏–ª–∏ –¥–ª—è –º–∞—è—á–∫–∞ */
        #sync-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #ff3b30;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: translate(40%, -40%);
            display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }
        
        #events-list { list-style: none; padding: 0; margin: 0; }
        #events-list li { padding: 10px 8px; font-size: 14px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        #events-list li:hover, #events-list li.highlighted { background-color: rgba(0, 122, 255, 0.1); }
        .layer-legend-color { display: inline-block; width: 12px; height: 12px; margin-right: 8px; border-radius: 3px; vertical-align: middle;}

        #layers-container .leaflet-control-layers { border: none; box-shadow: none; background: transparent; }

        .map-placement-mode { cursor: crosshair !important; }
        .custom-point-popup input { border: 1px solid #ccc; padding: 8px; border-radius: 4px; width: calc(100% - 18px); }
        .custom-point-popup button { border: none; background: var(--accent-color); color: white; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-top: 8px; }
        .custom-point-popup p { margin: 5px 0; font-weight: bold; }
        
        #iframe-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            gap: 15px;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #iframe-overlay.visible { opacity: 1; visibility: visible; }

        .iframe-container { width: 95%; height: 85%; position: relative; }
        #deepstate-iframe { width: 100%; height: 100%; border: 1px solid var(--border-color); border-radius: 8px; background: #fff; }
        #leaflet-overlay-map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; background: transparent; pointer-events: none; }
        #leaflet-overlay-map .leaflet-tile-pane { opacity: 0; }
        
        #transfer-coords-button { padding: 12px 25px; font-size: 16px; font-weight: 600; background: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid var(--accent-color); width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .intersection-icon { font-size: 24px !important; color: #d92f2f; text-shadow: 0 0 3px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="top-panel" class="collapsed">
        <div class="panel-header" id="panel-header-toggle">
            <h2>–ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∞ –ø–∞–Ω–µ–ª—å</h2>
            <div id="action-buttons">
                 <button id="sync-button" class="action-button" title="–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –∑ Google Sheet">
                    <i class="fa-solid fa-sync"></i>
                    <span id="sync-badge"></span>
                </button>
                <button id="deepstate-button" class="action-button" title="–ù–∞–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ DeepState Map"><i class="fa-solid fa-layer-group"></i></button>
                <button id="add-point-button" class="action-button" title="–î–æ–¥–∞—Ç–∏ –≤–ª–∞—Å–Ω—É —Ç–æ—á–∫—É"><i class="fa-solid fa-map-pin"></i></button>
                <button id="gps-button" class="action-button" title="–ó–Ω–∞–π—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ–ø–æ–ª–æ–∂–µ–Ω–Ω—è"><i class="fa-solid fa-location-crosshairs"></i></button>
                <button id="upload-button" class="action-button" title="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ª–æ–≥–∏"><i class="fa-solid fa-upload"></i></button>
                <button id="export-button" class="action-button" title="–ï–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä–µ—Ç–∏–Ω—ñ–≤ (GeoJSON)"><i class="fa-solid fa-file-export"></i></button>
                <i class="fa-solid fa-chevron-down" id="panel-toggle-icon" style="margin-left: 20px;"></i>
            </div>
        </div>
        <div class="panel-content">
            <div class="panel-column" id="calendar-column"><h3>–ö–∞–ª–µ–Ω–¥–∞—Ä</h3><div id="calendar-container"></div></div>
            <div class="panel-column" id="events-column"><h3 id="events-list-title">–ü–æ–¥—ñ—ó</h3><ul id="events-list"></ul></div>
            <div class="panel-column" id="layers-column"><h3>–®–∞—Ä–∏ –∫–∞—Ä—Ç–∏</h3><div id="layers-container"></div></div>
        </div>
    </div>
    
    <div id="iframe-overlay">
        <div class="iframe-container">
            <iframe id="deepstate-iframe" src="https://deepstatemap.live" frameborder="0"></iframe>
            <div id="leaflet-overlay-map"></div>
        </div>
        <button id="transfer-coords-button">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Ç–∞ –∑–∞–∫—Ä–∏—Ç–∏</button>
    </div>
    
    <input type="file" id="log-file-input" multiple accept=".json" style="display: none;">
    <div id="loader-overlay" class="hidden" style="display:none;"><div class="loader"></div></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro@2.9.6/build/vanilla-calendar.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        // --- üé® –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ URL –≤–∞—à–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞! ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxkqSsW2LAqmG4Mm8Ahqwr8ziKhXu_B2iilV1DjJ-94tCRxzopvI-uXqSrvGLDdI26r/exec'; 

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã ---
        const map = L.map('map', { zoomControl: false }).setView([50.41, 30.64], 11);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        const baseLayers = {
            "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }),
            "–°—É–ø—É—Ç–Ω–∏–∫": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri' }),
        };
        baseLayers["–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞"].addTo(map);
        
        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        let allLogsData = [], calendar, mapLayersControl, fileLayerGroups = {}, intersectionClusterGroup, selectedCalendarDate = null;
        let mapFeatures = {};
        let customPointsLayer = L.layerGroup().addTo(map);
        let overlayMap = null; 
        let overlayLayersGroup = L.layerGroup();

        // --- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ DOM ---
        const loader = document.getElementById('loader-overlay');
        const logFileInput = document.getElementById('log-file-input');
        const iframeOverlay = document.getElementById('iframe-overlay');
        
        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º ---
        document.getElementById('panel-header-toggle').addEventListener('click', (e) => {
            if (e.target.closest('.action-button')) return;
            document.getElementById('top-panel').classList.toggle('collapsed');
        });

        // --- –ü—Ä–∏–≤—è–∑–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π –∫ –∫–Ω–æ–ø–∫–∞–º ---
        document.getElementById('gps-button').addEventListener('click', () => {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude, lon = pos.coords.longitude, zoom = 13;
                map.flyTo([lat, lon], zoom);
                const deepstateIframe = document.getElementById('deepstate-iframe');
                deepstateIframe.src = `https://deepstatemap.live/#${zoom}/${lat.toFixed(5)}/${lon.toFixed(5)}`;
            }, () => alert("–ü–æ–º–∏–ª–∫–∞ GPS"));
        });

        document.getElementById('upload-button').addEventListener('click', () => logFileInput.click());
        logFileInput.addEventListener('change', handleFileSelect);
        document.getElementById('add-point-button').addEventListener('click', enterPointPlacementMode);
        
        // --- DeepState Map –æ–≤–µ—Ä–ª–µ–π ---
        document.getElementById('deepstate-button').addEventListener('click', () => {
            const center = map.getCenter(); const zoom = map.getZoom();
            document.getElementById('deepstate-iframe').src = `https://deepstatemap.live/#${zoom}/${center.lat.toFixed(5)}/${center.lng.toFixed(5)}`;
            iframeOverlay.classList.add('visible');
            if (!overlayMap) {
                overlayMap = L.map('leaflet-overlay-map', { zoomControl: false, attributionControl: false, layers: [overlayLayersGroup] });
            }
            overlayMap.setView(center, zoom);
            populateOverlayMap();
        });
        document.getElementById('transfer-coords-button').addEventListener('click', () => {
            iframeOverlay.classList.remove('visible');
            document.getElementById('map').classList.add('map-placement-mode');
            map.once('click', (e) => {
                createCustomPoint(e.latlng, '–¢–æ—á–∫–∞ –∑ DeepState');
                document.getElementById('map').classList.remove('map-placement-mode');
            });
        });

        function populateOverlayMap() {
            overlayLayersGroup.clearLayers();
            let filteredLogs = allLogsData.filter(log => !selectedCalendarDate || log.timestamp.startsWith(selectedCalendarDate));
            filteredLogs.forEach(log => { if (log.azimuth && log.distance) { drawObservation(log, overlayLayersGroup, true); } });
            if (intersectionClusterGroup) { intersectionClusterGroup.getLayers().forEach(marker => { L.marker(marker.getLatLng(), { icon: marker.options.icon }).bindPopup(marker.getPopup().getContent()).addTo(overlayLayersGroup); }); }
            customPointsLayer.getLayers().forEach(marker => {
                const newMarker = L.marker(marker.getLatLng(), { icon: marker.options.icon }).addTo(overlayLayersGroup);
                if (marker.customName) { newMarker.bindPopup(getPopupContent({_leaflet_id: 'clone', customName: marker.customName, getLatLng: marker.getLatLng})); }
            });
        }

        // --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç–æ—á–µ–∫ ---
        function enterPointPlacementMode() {
            document.getElementById('map').classList.add('map-placement-mode');
            map.once('click', (e) => { createCustomPoint(e.latlng); document.getElementById('map').classList.remove('map-placement-mode'); });
        }
        function createCustomPoint(latlng, initialName = '') {
            const marker = L.marker(latlng, { draggable: true, icon: L.divIcon({ className: 'fa-solid fa-map-pin', iconSize: [24, 24], html: `<i class="fa-solid fa-map-pin" style="font-size: 24px; color: var(--accent-color); text-shadow: 0 0 3px rgba(0,0,0,0.5);"></i>` }) }).addTo(customPointsLayer);
            marker.customName = initialName;
            marker.bindPopup(getPopupContent(marker)).openPopup();
        }
        function getPopupContent(marker) {
            const markerId = marker._leaflet_id;
            if (marker.customName) { return `<div class="custom-point-popup"><p>${marker.customName}</p><small>${marker.getLatLng().lat.toFixed(4)}, ${marker.getLatLng().lng.toFixed(4)}</small></div>`; }
            else { return `<div class="custom-point-popup"><input type="text" id="input-${markerId}" placeholder="–ù–∞–∑–≤–∞ —Ç–æ—á–∫–∏"><button id="btn-${markerId}">–ó–±–µ—Ä–µ–≥—Ç–∏</button></div>`; }
        }
        map.on('popupopen', function(e) {
            const marker = e.popup._source; if (!customPointsLayer.hasLayer(marker)) return;
            const markerId = marker._leaflet_id; const btn = document.getElementById(`btn-${markerId}`);
            if (btn) {
                btn.onclick = () => {
                    const input = document.getElementById(`input-${markerId}`);
                    marker.customName = input.value || "–ë–µ–∑ –Ω–∞–∑–≤–∏";
                    marker.setPopupContent(getPopupContent(marker));
                };
            }
        });

        // --- üé® –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –†–∞–±–æ—Ç–∞ —Å Google Sheets ---
        document.getElementById('sync-button').addEventListener('click', fetchDataFromSheet);

        async function fetchDataFromSheet() {
            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                alert('–ü–æ–º–∏–ª–∫–∞: URL Google Apps Script –Ω–µ –≤–∫–∞–∑–∞–Ω–æ –≤ –∫–æ–¥—ñ.');
                return;
            }
            loader.style.display = 'flex';
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const sheetData = await response.json();
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                const lastSyncTimestamp = localStorage.getItem('lastSyncTimestamp') || 0;
                let newEventsCount = 0;
                
                const formattedData = sheetData.map((row, index) => {
                    if (new Date(row.Timestamp).getTime() > lastSyncTimestamp) {
                        newEventsCount++;
                    }
                    return {
                        name: row.Event,
                        timestamp: row.Timestamp,
                        azimuth: row.Azimuth,
                        distance: row.Distance ? parseInt(row.Distance, 10) : null,
                        comment: row.Comment,
                        uniqueId: row.UniqueID || `sheet_${index}`,
                        originCoordinates: { lat: parseFloat(row.Latitude), lon: parseFloat(row.Longitude) },
                        fileName: `Sheet: ${row.Shift} | ${row.Position}`,
                        fileColor: generateHslColor(index, sheetData.length) // –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —É–º–Ω–µ–µ, –Ω–æ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Å–æ–π–¥–µ—Ç
                    };
                });
                
                allLogsData = formattedData;
                
                initCalendar();
                updateMap();
                displayEventsList(allLogsData, null);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—è—á–æ–∫ –∏ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                const syncBadge = document.getElementById('sync-badge');
                if (newEventsCount > 0) {
                    syncBadge.textContent = newEventsCount;
                    syncBadge.style.display = 'flex';
                } else {
                    syncBadge.style.display = 'none';
                }
                localStorage.setItem('lastSyncTimestamp', new Date().getTime());
                
            } catch (error) {
                alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∑ Google Sheet.');
                console.error('Fetch error:', error);
            } finally {
                loader.style.display = 'none';
            }
        }
        
        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ (–æ—Å—Ç–∞–µ—Ç—Å—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã) ---
        function handleFileSelect(event) {
            loader.style.display = 'flex';
            if (mapLayersControl) { map.removeControl(mapLayersControl); mapLayersControl = null; }
            Object.values(fileLayerGroups).forEach(group => group.clearLayers());
            if (intersectionClusterGroup) intersectionClusterGroup.clearLayers();
            allLogsData = []; fileLayerGroups = {}; mapFeatures = {};
            let logIdCounter = 0;
            const files = Array.from(event.target.files);
            const promises = files.map((file, index) => new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result); let processedLogs = [];
                        if (data.events && data.position && data.position.location) {
                            const originCoordinates = { lat: data.position.location.lat, lon: data.position.location.lon };
                            data.events.forEach(event => { processedLogs.push({ ...event, distance: event.distance ? parseInt(event.distance, 10) : null, uniqueId: `log_${logIdCounter++}`, originCoordinates: originCoordinates, fileName: file.name, fileColor: generateHslColor(index, files.length) }); });
                        } else if (data.logs && data.originCoordinates) {
                            data.logs.forEach(log => { log.uniqueId = `log_${logIdCounter++}`; log.originCoordinates = data.originCoordinates; log.fileName = file.name; log.fileColor = generateHslColor(index, files.length); processedLogs.push(log); });
                        } else { alert(`–§–∞–π–ª ${file.name} –º–∞—î –Ω–µ–≤—ñ–¥–æ–º–∏–π —Ñ–æ—Ä–º–∞—Ç.`); }
                        allLogsData.push(...processedLogs);
                    } catch (error) { alert(`–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É —Ñ–∞–π–ª—É ${file.name}.`); console.error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ ${file.name}:`, error); }
                    resolve();
                };
                reader.readAsText(file);
            }));
            Promise.all(promises).then(() => {
                initCalendar(); updateMap(); displayEventsList(allLogsData, null);
                document.getElementById('top-panel').classList.remove('collapsed');
                loader.style.display = 'none';
            });
        }
        
        // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã ---
        function updateMap() {
            if (mapLayersControl) { map.removeControl(mapLayersControl); mapLayersControl = null; }
            Object.values(fileLayerGroups).forEach(group => group.clearLayers());
            if (intersectionClusterGroup) { intersectionClusterGroup.clearLayers(); map.removeLayer(intersectionClusterGroup); }
            fileLayerGroups = {}; mapFeatures = {};
            let filteredLogs = allLogsData.filter(log => !selectedCalendarDate || log.timestamp.startsWith(selectedCalendarDate));
            drawLogVisuals(filteredLogs);
            calculateAndDrawIntersections(filterForIntersection(filteredLogs));
        }
        
        // --- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π ---
        function initCalendar() {
            const eventDates = [...new Set(allLogsData.map(log => log.timestamp.substring(0, 10)))];
            const options = {
                actions: { clickDay(e, self) {
                    selectedCalendarDate = self.selectedDates[0] || null;
                    const eventsForDate = selectedCalendarDate ? allLogsData.filter(log => log.timestamp.startsWith(selectedCalendarDate)) : allLogsData;
                    displayEventsList(eventsForDate, selectedCalendarDate);
                    updateMap();
                }},
                settings: { visibility: { highlighted: eventDates } },
            };
            if (calendar) calendar.destroy();
            calendar = new VanillaCalendar('#calendar-container', options);
            calendar.init();
        }
        function displayEventsList(events, date) {
            const list = document.getElementById('events-list'); list.innerHTML = '';
            document.getElementById('events-list-title').textContent = date ? `–ü–æ–¥—ñ—ó –∑–∞ ${date}` : '–í—Å—ñ –ø–æ–¥—ñ—ó';
            if (events.length === 0) { list.innerHTML = '<li>–ù–µ–º–∞—î –ø–æ–¥—ñ–π.</li>'; return; }
            events.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            events.forEach(log => {
                const time = new Date(log.timestamp).toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
                const li = document.createElement('li'); li.dataset.logId = log.uniqueId;
                li.innerHTML = `<span class="layer-legend-color" style="background-color: ${log.fileColor};"></span><span><b>${log.name || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</b> (${log.distance || 'N/A'}m) <small style="opacity:0.7;">- ${time}</small></span>`;
                list.appendChild(li);
            });
        }

        // --- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–ø–∏—Å–∫–∞ –∏ –∫–∞—Ä—Ç—ã ---
        const eventsListElement = document.getElementById('events-list');
        eventsListElement.addEventListener('mouseover', (e) => {
            const li = e.target.closest('li'); if (!li || !li.dataset.logId) return;
            document.querySelectorAll('#events-list li').forEach(el => el.classList.remove('highlighted'));
            li.classList.add('highlighted');
            const feature = mapFeatures[li.dataset.logId];
            if (feature && feature.polyline) { feature.polyline.setStyle({ weight: 7 }); }
        });
        eventsListElement.addEventListener('mouseout', (e) => {
            document.querySelectorAll('#events-list li').forEach(el => el.classList.remove('highlighted'));
            Object.values(mapFeatures).forEach(feature => {
                if (feature.polyline) { feature.polyline.setStyle({ weight: 3 }); }
            });
        });
        eventsListElement.addEventListener('click', (e) => {
            const li = e.target.closest('li'); if (!li || !li.dataset.logId) return;
            const feature = mapFeatures[li.dataset.logId];
            if (feature && feature.marker) { map.flyTo(feature.marker.getLatLng(), 15); feature.marker.openPopup(); }
        });
        
        function drawLogVisuals(logsToDraw) {
            const overlayMaps = {}; const logsByFile = logsToDraw.reduce((acc, log) => { if (!acc[log.fileName]) acc[log.fileName] = []; acc[log.fileName].push(log); return acc; }, {});
            for (const fileName in logsByFile) {
                const logs = logsByFile[fileName]; if (logs.length === 0) continue;
                const fileColor = logs[0].fileColor; const fileGroup = L.layerGroup(); const originsDrawn = new Set();
                logs.forEach(log => {
                    const origin = log.originCoordinates; if (!originsDrawn.has(`${origin.lat},${origin.lon}`)) {
                        L.marker([origin.lat, origin.lon], { icon: L.divIcon({ className: 'fa-solid fa-user-secret', iconSize: [20, 20], html: `<i class="fa-solid fa-user-secret" style="color: ${fileColor}; font-size: 20px;"></i>` }) }).addTo(fileGroup).bindPopup(`<b>–°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á</b><br>${fileName}`);
                        originsDrawn.add(`${origin.lat},${origin.lon}`);
                    }
                    if (log.azimuth && log.distance) drawObservation(log, fileGroup);
                });
                fileLayerGroups[fileName] = fileGroup; overlayMaps[`<span class="layer-legend-color" style="background-color:${fileColor};"></span> ${fileName.substring(0, 25)}...`] = fileGroup;
            }
            if (intersectionClusterGroup && intersectionClusterGroup.getLayers().length > 0) { overlayMaps[`<i class="fa-solid fa-crosshairs" style="color:#d92f2f;"></i> –ü–µ—Ä–µ—Ç–∏–Ω–∏`] = intersectionClusterGroup; }
            overlayMaps[`<i class="fa-solid fa-map-pin" style="color:var(--accent-color);"></i> –ú–æ—ó —Ç–æ—á–∫–∏`] = customPointsLayer;
            mapLayersControl = L.control.layers(baseLayers, overlayMaps, { collapsed: false });
            mapLayersControl.addTo(map);
            document.getElementById('layers-container').appendChild(mapLayersControl.getContainer());
            Object.values(fileLayerGroups).forEach(group => map.addLayer(group));
            if (intersectionClusterGroup) map.addLayer(intersectionClusterGroup);
        }
        
        function drawObservation(log, layerGroup, isOverlay = false) {
            const originPoint = [log.originCoordinates.lat, log.originCoordinates.lon];
            const averageAzimuth = (parseAzimuth(log.azimuth)[0] + parseAzimuth(log.azimuth)[1]) / 2;
            const targetPoint = getDestPoint(originPoint[0], originPoint[1], averageAzimuth, log.distance);
            const polyline = L.polyline([originPoint, targetPoint], { color: log.fileColor, weight: 3, opacity: 0.9 }).addTo(layerGroup);
            const marker = L.circle(targetPoint, { color: log.fileColor, fillColor: log.fileColor, fillOpacity: 0.4, radius: 25 }).addTo(layerGroup);
            if (!isOverlay) {
                marker.bindPopup(`<b>${log.name}</b><br><b>–î–∏—Å—Ç:</b> ${log.distance} –º`);
                mapFeatures[log.uniqueId] = { marker, polyline };
            }
        }
        
        function filterForIntersection(logs) { return logs.filter(log => { if (!log.name || !log.azimuth || !log.distance) return false; const [startAz, endAz] = parseAzimuth(log.azimuth); return (endAz - startAz) <= 10; }); }
        function calculateAndDrawIntersections(logs) {
            intersectionClusterGroup = L.markerClusterGroup();
            for (let i = 0; i < logs.length; i++) { for (let j = i + 1; j < logs.length; j++) {
                const logA = logs[i], logB = logs[j]; if (logA.originCoordinates.lat === logB.originCoordinates.lat && logA.originCoordinates.lon === logB.originCoordinates.lon) continue;
                const iPoint = findIntersection(logA, logB);
                if (iPoint) {
                    const distA = calculateDistance(logA.originCoordinates.lat, logA.originCoordinates.lon, iPoint[0], iPoint[1]); const distB = calculateDistance(logB.originCoordinates.lat, logB.originCoordinates.lon, iPoint[0], iPoint[1]);
                    const popup = `<b>–ü–µ—Ä–µ—Ç–∏–Ω</b><br><b>–ö–æ–æ—Ä–¥:</b> ${iPoint[0].toFixed(5)}, ${iPoint[1].toFixed(5)}<hr><b>–§–∞–π–ª 1:</b> ${logA.fileName}<br><b>–î–∏—Å—Ç:</b> ${Math.round(distA)} –º<br><hr><b>–§–∞–π–ª 2:</b> ${logB.fileName}<br><b>–î–∏—Å—Ç:</b> ${Math.round(distB)} –º`;
                    const marker = L.marker(iPoint, { icon: L.divIcon({ className: 'fa-solid fa-crosshairs intersection-icon', iconSize: [24, 24] }) }).bindPopup(popup);
                    marker.feature = { type: "Feature", geometry: { type: "Point", coordinates: [iPoint[1], iPoint[0]] }, properties: { file1: logA.fileName, dist1: Math.round(distA), file2: logB.fileName, dist2: Math.round(distB) } };
                    intersectionClusterGroup.addLayer(marker);
                }
            }}
        }
        document.getElementById('export-button').addEventListener('click', () => {
            const layersToExport = [ ...Object.values(fileLayerGroups).flatMap(lg => lg.getLayers()), ...(intersectionClusterGroup ? intersectionClusterGroup.getLayers() : []), ...customPointsLayer.getLayers() ];
            if (layersToExport.length === 0) { return alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É."); }
            const featureGroup = L.featureGroup(layersToExport); const geoJson = featureGroup.toGeoJSON();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geoJson, null, 2)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "map_data.geojson"); document.body.appendChild(dl); dl.click(); dl.remove();
        });
        function generateHslColor(index, total) { const hue = (index * (360 / total)) % 360; return `hsl(${hue}, 70%, 50%)`; }
        function parseAzimuth(az) { if (typeof az === 'string' && az.includes('-')) return az.split('-').map(Number); return [Number(az), Number(az)]; }
        function getDestPoint(lat, lon, brng, dist) { const R = 6371e3; const l1 = lat * Math.PI / 180, n1 = lon * Math.PI / 180, b = brng * Math.PI / 180; const l2 = Math.asin(Math.sin(l1) * Math.cos(dist / R) + Math.cos(l1) * Math.sin(dist / R) * Math.cos(b)); const n2 = n1 + Math.atan2(Math.sin(b) * Math.sin(dist / R) * Math.cos(l1), Math.cos(dist / R) - Math.sin(l1) * Math.sin(l2)); return [l2 * 180 / Math.PI, n2 * 180 / Math.PI]; }
        function findIntersection(logA, logB) { const azA = (parseAzimuth(logA.azimuth)[0] + parseAzimuth(logA.azimuth)[1]) / 2; const azB = (parseAzimuth(logB.azimuth)[0] + parseAzimuth(logB.azimuth)[1]) / 2; const p1 = logA.originCoordinates, p3 = logB.originCoordinates; const p2 = getDestPoint(p1.lat, p1.lon, azA, 10000), p4 = getDestPoint(p3.lat, p3.lon, azB, 10000); const x1 = p1.lon, y1 = p1.lat, x2 = p2[1], y2 = p2[0], x3 = p3.lon, y3 = p3.lat, x4 = p4[1], y4 = p4[0]; const den = (x1 - x2) * (y3 - y4) - (y1 - y2) * (x3 - x4); if (den === 0) return null; const t = ((x1 - x3) * (y3 - y4) - (y1 - y3) * (x3 - x4)) / den; const u = -((x1 - x2) * (y1 - y3) - (y1 - y2) * (x1 - x3)) / den; if (t > 0 && u > 0) return [y1 + t * (y2 - y1), x1 + t * (x2 - x1)]; return null; }
        function calculateDistance(lat1, lon1, lat2, lon2) { const R = 6371e3; const p1 = lat1 * Math.PI / 180, p2 = lat2 * Math.PI / 180; const dP = (lat2 - lat1) * Math.PI / 180; const dL = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(dP / 2) * Math.sin(dP / 2) + Math.cos(p1) * Math.cos(p2) * Math.sin(dL / 2) * Math.sin(dL / 2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return R * c; }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', fetchDataFromSheet);

    </script>
</body>
</html>

