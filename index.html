<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта - Аналітична панель</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro@2.9.6/build/vanilla-calendar.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <style>
        :root {
            --bg-color: rgba(255, 255, 255, 0.85);
            --blur-effect: backdrop-filter: blur(10px);
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --text-color: #2c2c2c;
            --accent-color: #007aff;
            --transition-speed: 0.3s;
        }

        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Inter', sans-serif; color: var(--text-color); background-color: #eef1f4; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        
        #top-panel { position: absolute; top: 0; left: 0; right: 0; z-index: 1000; background: var(--bg-color); -webkit-backdrop-filter: var(--blur-effect); backdrop-filter: var(--blur-effect); border-bottom: 1px solid var(--border-color); box-shadow: 0 4px 20px var(--shadow-color); }
        .panel-header { padding: 0 20px; height: 55px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .panel-header h2 { margin: 0; font-size: 18px; }
        #panel-toggle-icon { transition: transform var(--transition-speed) ease; }
        #top-panel.collapsed #panel-toggle-icon { transform: rotate(-180deg); }
        
        .panel-content { max-height: 0; overflow: hidden; transition: max-height var(--transition-speed) ease-in-out; display: flex; padding: 0 10px; border-top: 1px solid transparent; }
        #top-panel:not(.collapsed) .panel-content { max-height: 50vh; padding: 10px; border-top-color: var(--border-color); }
        
        .panel-column { padding: 0 10px; height: calc(50vh - 20px); display: flex; flex-direction: column; }
        .panel-column h3 { margin: 0 0 10px 0; font-size: 16px; font-weight: 600; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); }
        #calendar-column { flex: 0 0 300px; }
        #events-column { flex: 1 1 40%; overflow-y: auto; }
        #layers-column { flex: 1 1 30%; }

        #action-buttons { display: flex; gap: 15px; }
        .action-button { background: none; border: none; font-size: 18px; cursor: pointer; color: var(--text-color); padding: 5px; position: relative; }
        
        #sync-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #ff3b30;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: translate(40%, -40%);
            display: none; 
        }
        
        #events-list { list-style: none; padding: 0; margin: 0; }
        #events-list li { padding: 10px 8px; font-size: 14px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        #events-list li:hover, #events-list li.highlighted { background-color: rgba(0, 122, 255, 0.1); }
        .layer-legend-color { display: inline-block; width: 12px; height: 12px; margin-right: 8px; border-radius: 3px; vertical-align: middle;}

        #layers-container .leaflet-control-layers { border: none; box-shadow: none; background: transparent; }

        .map-placement-mode { cursor: crosshair !important; }
        .custom-point-popup input { border: 1px solid #ccc; padding: 8px; border-radius: 4px; width: calc(100% - 18px); }
        .custom-point-popup button { border: none; background: var(--accent-color); color: white; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-top: 8px; }
        .custom-point-popup p { margin: 5px 0; font-weight: bold; }
        
        #iframe-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            gap: 15px;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #iframe-overlay.visible { opacity: 1; visibility: visible; }

        .iframe-container { width: 95%; height: 85%; position: relative; }
        #deepstate-iframe { width: 100%; height: 100%; border: 1px solid var(--border-color); border-radius: 8px; background: #fff; }
        #leaflet-overlay-map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; background: transparent; pointer-events: none; }
        #leaflet-overlay-map .leaflet-tile-pane { opacity: 0; }
        
        #transfer-coords-button { padding: 12px 25px; font-size: 16px; font-weight: 600; background: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid var(--accent-color); width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .intersection-icon { font-size: 24px !important; color: #d92f2f; text-shadow: 0 0 3px rgba(0,0,0,0.5); }


        /* --- СТИЛІ МОДАЛЬНОГО ВІКНА --- */
#event-modal-overlay {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 2500;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0; visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}
#event-modal-overlay.visible {
    opacity: 1; visibility: visible;
}
#event-modal-content {
    background: var(--bg-color);
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 5px 25px var(--shadow-color);
    width: 90%;
    max-width: 500px;
    position: relative;
    -webkit-backdrop-filter: var(--blur-effect);
    backdrop-filter: var(--blur-effect);
}
.modal-close {
    position: absolute;
    top: 10px; right: 15px;
    font-size: 28px;
    font-weight: bold;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-color);
    opacity: 0.7;
    transition: opacity 0.2s;
}
.modal-close:hover { opacity: 1; }
#event-modal-content h3 {
    margin-top: 0;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
    margin-bottom: 15px;
}
#modal-info p { margin: 8px 0; }
#modal-info p strong { color: #555; }
#modal-actions {
    margin-top: 20px;
    display: flex;
    gap: 15px;
    border-top: 1px solid var(--border-color);
    padding-top: 15px;
}
#modal-actions button {
    border: none;
    background: var(--accent-color);
    color: white;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: background-color 0.2s;
}
#modal-actions button:hover {
    background-color: #0056b3;
}
        
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="top-panel" class="collapsed">
        <div class="panel-header" id="panel-header-toggle">
            <h2>Аналітична панель</h2>
            <div id="action-buttons">
                <button id="sync-button" class="action-button" title="Синхронізувати з Google Sheet">
                    <i class="fa-solid fa-sync"></i>
                    <span id="sync-badge"></span>
                </button>
                <button id="deepstate-button" class="action-button" title="Наложение на DeepState Map"><i class="fa-solid fa-layer-group"></i></button>
                <button id="add-point-button" class="action-button" title="Додати власну точку"><i class="fa-solid fa-map-pin"></i></button>
                <button id="gps-button" class="action-button" title="Знайти моє місцеположення"><i class="fa-solid fa-location-crosshairs"></i></button>
                <button id="upload-button" class="action-button" title="Завантажити логи"><i class="fa-solid fa-upload"></i></button>
                <button id="export-button" class="action-button" title="Експорт перетинів (GeoJSON)"><i class="fa-solid fa-file-export"></i></button>
                <i class="fa-solid fa-chevron-down" id="panel-toggle-icon" style="margin-left: 20px;"></i>
            </div>
        </div>
        <div class="panel-content">
            <div class="panel-column" id="calendar-column"><h3>Календар</h3><div id="calendar-container"></div></div>
            <div class="panel-column" id="events-column"><h3 id="events-list-title">Події</h3><ul id="events-list"></ul></div>
            <div class="panel-column" id="layers-column"><h3>Шари карти</h3><div id="layers-container"></div></div>
        </div>
    </div>
    
    <div id="iframe-overlay">
        <div class="iframe-container">
            <iframe id="deepstate-iframe" src="https://deepstatemap.live" frameborder="0"></iframe>
            <div id="leaflet-overlay-map"></div>
        </div>
        <button id="transfer-coords-button">Перенести координати та закрити</button>
    </div>
    
    <input type="file" id="log-file-input" multiple accept=".json" style="display: none;">
    <div id="loader-overlay" class="hidden" style="display:none;"><div class="loader"></div></div>

    <div id="event-modal-overlay">
    <div id="event-modal-content">
        <button id="modal-close-button" class="modal-close">&times;</button>
        <h3 id="modal-title">Деталі події</h3>
        <div id="modal-info">
            <p><strong>Координати:</strong> <span id="modal-coords"></span></p>
            <p><strong>Час події:</strong> <span id="modal-datetime"></span></p>
            <p><strong>Коментар:</strong> <span id="modal-comment"></span></p>
        </div>
        <div id="modal-actions">
            <button id="modal-draw-arrow">Намалювати стрілку</button>
            <button id="modal-draw-line">Намалювати лінію</button>
        </div>
    </div>
</div>


    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro@2.9.6/build/vanilla-calendar.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWLzQoJq0hfHer7Vsdk2xJe_Z7aNA4SRhiU0NWkMPv3IZAdcMFkyH-GrkXm6WK5SEZ/exec'; 

        // --- Инициализация карты ---
        const map = L.map('map', { zoomControl: false }).setView([50.41, 30.64], 11);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        const baseLayers = {
            "Стандартна": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }),
            "Супутник": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri' }),
        };
        baseLayers["Стандартна"].addTo(map);
        
             // --- Глобальные переменные ---
        let allLogsData = [], calendar, mapLayersControl, fileLayerGroups = {}, intersectionClusterGroup, selectedCalendarDate = null;
        let mapFeatures = {};
        let customPointsLayer = L.layerGroup().addTo(map);
        let overlayMap = null; 
        let overlayLayersGroup = L.layerGroup();
        let lastSyncRowCount = 0; 
        let drawingsLayer = L.layerGroup().addTo(map); // <-- ДОБАВИТЬ ЭТО
        let currentModalLog = null; // <-- И ЭТО
        

        // --- Получение ссылок на DOM ---
        const loader = document.getElementById('loader-overlay');
        const logFileInput = document.getElementById('log-file-input');
        const iframeOverlay = document.getElementById('iframe-overlay');
        
        // --- Управление интерфейсом ---
        document.getElementById('panel-header-toggle').addEventListener('click', (e) => {
            if (e.target.closest('.action-button')) return;
            document.getElementById('top-panel').classList.toggle('collapsed');
        });

        // --- Привязка действий к кнопкам ---
        document.getElementById('gps-button').addEventListener('click', () => {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude, lon = pos.coords.longitude, zoom = 13;
                map.flyTo([lat, lon], zoom);
                const deepstateIframe = document.getElementById('deepstate-iframe');
                deepstateIframe.src = `https://deepstatemap.live/#${zoom}/${lat.toFixed(5)}/${lon.toFixed(5)}`;
            }, () => alert("Помилка GPS"));
        });

        document.getElementById('upload-button').addEventListener('click', () => logFileInput.click());
        logFileInput.addEventListener('change', handleFileSelect);
        document.getElementById('add-point-button').addEventListener('click', enterPointPlacementMode);
        
        // --- DeepState Map оверлей ---
        document.getElementById('deepstate-button').addEventListener('click', () => {
            const center = map.getCenter(); const zoom = map.getZoom();
            document.getElementById('deepstate-iframe').src = `https://deepstatemap.live/#${zoom}/${center.lat.toFixed(5)}/${center.lng.toFixed(5)}`;
            iframeOverlay.classList.add('visible');
            if (!overlayMap) {
                overlayMap = L.map('leaflet-overlay-map', { zoomControl: false, attributionControl: false, layers: [overlayLayersGroup] });
            }
            overlayMap.setView(center, zoom);
            populateOverlayMap();
        });
        document.getElementById('transfer-coords-button').addEventListener('click', () => {
            iframeOverlay.classList.remove('visible');
            document.getElementById('map').classList.add('map-placement-mode');
            map.once('click', (e) => {
                createCustomPoint(e.latlng, 'Точка з DeepState');
                document.getElementById('map').classList.remove('map-placement-mode');
            });
        });

        function populateOverlayMap() {
            overlayLayersGroup.clearLayers();
            let filteredLogs = allLogsData.filter(log => !selectedCalendarDate || log.timestamp.startsWith(selectedCalendarDate));
            filteredLogs.forEach(log => { if (log.azimuth && log.distance) { drawObservation(log, overlayLayersGroup, true); } });
            if (intersectionClusterGroup) {
                intersectionClusterGroup.getLayers().forEach(marker => { L.marker(marker.getLatLng(), { icon: marker.options.icon }).bindPopup(marker.getPopup().getContent()).addTo(overlayLayersGroup); });
            }
            customPointsLayer.getLayers().forEach(marker => {
                const newMarker = L.marker(marker.getLatLng(), { icon: marker.options.icon }).addTo(overlayLayersGroup);
                if (marker.customName) { newMarker.bindPopup(getPopupContent({_leaflet_id: 'clone', customName: marker.customName, getLatLng: marker.getLatLng})); }
            });
        }

        // --- Добавление пользовательских точек ---
        function enterPointPlacementMode() {
            document.getElementById('map').classList.add('map-placement-mode');
            map.once('click', (e) => { createCustomPoint(e.latlng); document.getElementById('map').classList.remove('map-placement-mode'); });
        }
        function createCustomPoint(latlng, initialName = '') {
            const marker = L.marker(latlng, { draggable: true, icon: L.divIcon({ className: 'fa-solid fa-map-pin', iconSize: [24, 24], html: `<i class="fa-solid fa-map-pin" style="font-size: 24px; color: var(--accent-color); text-shadow: 0 0 3px rgba(0,0,0,0.5);"></i>` }) }).addTo(customPointsLayer);
            marker.customName = initialName;
            marker.bindPopup(getPopupContent(marker)).openPopup();
        }
        function getPopupContent(marker) {
            const markerId = marker._leaflet_id;
            if (marker.customName) { return `<div class="custom-point-popup"><p>${marker.customName}</p><small>${marker.getLatLng().lat.toFixed(4)}, ${marker.getLatLng().lng.toFixed(4)}</small></div>`; }
            else { return `<div class="custom-point-popup"><input type="text" id="input-${markerId}" placeholder="Назва точки"><button id="btn-${markerId}">Зберегти</button></div>`; }
        }
        map.on('popupopen', function(e) {
            const marker = e.popup._source; if (!customPointsLayer.hasLayer(marker)) return;
            const markerId = marker._leaflet_id; const btn = document.getElementById(`btn-${markerId}`);
            if (btn) {
                btn.onclick = () => {
                    const input = document.getElementById(`input-${markerId}`);
                    marker.customName = input.value || "Без назви";
                    marker.setPopupContent(getPopupContent(marker));
                };
            }
        });

        // --- Работа с Google Sheets ---
        document.getElementById('sync-button').addEventListener('click', () => fetchDataFromSheet(false)); // false = не тихий режим

        async function fetchDataFromSheet(isSilent = false) {
            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                if (!isSilent) alert('Помилка: URL Google Apps Script не вказано в коді.');
                return;
            }
            if (!isSilent) loader.style.display = 'flex';
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                const sheetData = await response.json();
                
                if (isSilent) {
                    const newRowCount = sheetData.length;
                    const newEventsCount = newRowCount - lastSyncRowCount;
                    const syncBadge = document.getElementById('sync-badge');
                    if (newEventsCount > 0) {
                        syncBadge.textContent = newEventsCount;
                        syncBadge.style.display = 'flex';
                    } else {
                        syncBadge.style.display = 'none';
                    }
                    return;
                }

                lastSyncRowCount = sheetData.length;
                document.getElementById('sync-badge').style.display = 'none';

                const formattedData = sheetData.map((row, index) => {
                    return {
                        name: row.Event, timestamp: row.Timestamp, azimuth: row.Azimuth,
                        distance: row.Distance ? parseInt(row.Distance, 10) : null,
                        comment: row.Comment, uniqueId: row.UniqueID || `sheet_${index}`,
                        originCoordinates: { lat: parseFloat(row.Latitude), lon: parseFloat(row.Longitude) },
                        fileName: `Sheet: ${row.Shift} | ${row.Position}`,
                        fileColor: generateHslColor(index, sheetData.length)
                    };
                });
                
                allLogsData = formattedData;
                initCalendar(); updateMap(); displayEventsList(allLogsData, null);
                
            } catch (error) {
                if (!isSilent) alert('Не вдалося завантажити дані з Google Sheet.');
                console.error('Fetch error:', error);
            } finally {
                if (!isSilent) loader.style.display = 'none';
            }
        }
        
        // --- Загрузка и обработка файлов ---
        function handleFileSelect(event) {
            loader.style.display = 'flex';
            if (mapLayersControl) { map.removeControl(mapLayersControl); mapLayersControl = null; }
            Object.values(fileLayerGroups).forEach(group => group.clearLayers());
            if (intersectionClusterGroup) intersectionClusterGroup.clearLayers();
            allLogsData = []; fileLayerGroups = {}; mapFeatures = {};
            let logIdCounter = 0;
            const files = Array.from(event.target.files);
            const promises = files.map((file, index) => new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result); let processedLogs = [];
                        if (data.events && data.position && data.position.location) {
                            const originCoordinates = { lat: data.position.location.lat, lon: data.position.location.lon };
                            data.events.forEach(event => { processedLogs.push({ ...event, distance: event.distance ? parseInt(event.distance, 10) : null, uniqueId: `log_${logIdCounter++}`, originCoordinates: originCoordinates, fileName: file.name, fileColor: generateHslColor(index, files.length) }); });
                        } else if (data.logs && data.originCoordinates) {
                            data.logs.forEach(log => { log.uniqueId = `log_${logIdCounter++}`; log.originCoordinates = data.originCoordinates; log.fileName = file.name; log.fileColor = generateHslColor(index, files.length); processedLogs.push(log); });
                        } else { alert(`Файл ${file.name} має невідомий формат.`); }
                        allLogsData.push(...processedLogs);
                    } catch (error) { alert(`Помилка парсингу файлу ${file.name}.`); console.error(`Ошибка парсинга ${file.name}:`, error); }
                    resolve();
                };
                reader.readAsText(file);
            }));
            Promise.all(promises).then(() => {
                initCalendar(); updateMap(); displayEventsList(allLogsData, null);
                document.getElementById('top-panel').classList.remove('collapsed');
                loader.style.display = 'none';
            });
        }
        
        // --- Обновление карты ---
        function updateMap() {
            if (mapLayersControl) { map.removeControl(mapLayersControl); mapLayersControl = null; }
            Object.values(fileLayerGroups).forEach(group => group.clearLayers());
            if (intersectionClusterGroup) { intersectionClusterGroup.clearLayers(); map.removeLayer(intersectionClusterGroup); }
            fileLayerGroups = {}; mapFeatures = {};
            let filteredLogs = allLogsData.filter(log => !selectedCalendarDate || log.timestamp.startsWith(selectedCalendarDate));
            drawLogVisuals(filteredLogs);
            calculateAndDrawIntersections(filterForIntersection(filteredLogs));
        }
        
        // --- Календарь и Список событий ---
        function initCalendar() {
            const eventDates = [...new Set(allLogsData.map(log => log.timestamp.substring(0, 10)))];
            const options = {
                actions: { clickDay(e, self) {
                    selectedCalendarDate = self.selectedDates[0] || null;
                    const eventsForDate = selectedCalendarDate ? allLogsData.filter(log => log.timestamp.startsWith(selectedCalendarDate)) : allLogsData;
                    displayEventsList(eventsForDate, selectedCalendarDate);
                    updateMap();
                }},
                settings: { visibility: { highlighted: eventDates } },
            };
            if (calendar) calendar.destroy();
            calendar = new VanillaCalendar('#calendar-container', options);
            calendar.init();
        }
        function displayEventsList(events, date) {
            const list = document.getElementById('events-list'); list.innerHTML = '';
            document.getElementById('events-list-title').textContent = date ? `Події за ${date}` : 'Всі події';
            if (events.length === 0) { list.innerHTML = '<li>Немає подій.</li>'; return; }
            events.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            events.forEach(log => {
                const time = new Date(log.timestamp).toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
                const li = document.createElement('li'); li.dataset.logId = log.uniqueId;
                li.innerHTML = `<span class="layer-legend-color" style="background-color: ${log.fileColor};"></span><span><b>${log.name || 'Без назви'}</b> (${log.distance || 'N/A'}m) <small style="opacity:0.7;">- ${time}</small></span>`;
                list.appendChild(li);
            });
        }

        // --- Интерактивность списка и карты ---
        const eventsListElement = document.getElementById('events-list');
        eventsListElement.addEventListener('mouseover', (e) => {
            const li = e.target.closest('li'); if (!li || !li.dataset.logId) return;
            document.querySelectorAll('#events-list li').forEach(el => el.classList.remove('highlighted'));
            li.classList.add('highlighted');
            const feature = mapFeatures[li.dataset.logId];
            if (feature && feature.polyline) { feature.polyline.setStyle({ weight: 7 }); }
        });
        eventsListElement.addEventListener('mouseout', (e) => {
            document.querySelectorAll('#events-list li').forEach(el => el.classList.remove('highlighted'));
            Object.values(mapFeatures).forEach(feature => {
                if (feature.polyline) { feature.polyline.setStyle({ weight: 3 }); }
            });
        });
        eventsListElement.addEventListener('click', (e) => {
            const li = e.target.closest('li'); if (!li || !li.dataset.logId) return;
            const feature = mapFeatures[li.dataset.logId];
            if (feature && feature.marker) { map.flyTo(feature.marker.getLatLng(), 15); feature.marker.openPopup(); }
        });
        
        function drawLogVisuals(logsToDraw) {
            const overlayMaps = {}; const logsByFile = logsToDraw.reduce((acc, log) => { if (!acc[log.fileName]) acc[log.fileName] = []; acc[log.fileName].push(log); return acc; }, {});
            for (const fileName in logsByFile) {
                const logs = logsByFile[fileName]; if (logs.length === 0) continue;
                const fileColor = logs[0].fileColor; const fileGroup = L.layerGroup(); const originsDrawn = new Set();
                logs.forEach(log => {
                    const origin = log.originCoordinates; if (!originsDrawn.has(`${origin.lat},${origin.lon}`)) {
                        L.marker([origin.lat, origin.lon], { icon: L.divIcon({ className: 'fa-solid fa-user-secret', iconSize: [20, 20], html: `<i class="fa-solid fa-user-secret" style="color: ${fileColor}; font-size: 20px;"></i>` }) }).addTo(fileGroup).bindPopup(`<b>Спостерігач</b><br>${fileName}`);
                        originsDrawn.add(`${origin.lat},${origin.lon}`);
                    }
                    if (log.azimuth && log.distance) drawObservation(log, fileGroup);
                });
                fileLayerGroups[fileName] = fileGroup; overlayMaps[`<span class="layer-legend-color" style="background-color:${fileColor};"></span> ${fileName.substring(0, 25)}...`] = fileGroup;
            }
            if (intersectionClusterGroup && intersectionClusterGroup.getLayers().length > 0) { overlayMaps[`<i class="fa-solid fa-crosshairs" style="color:#d92f2f;"></i> Перетини`] = intersectionClusterGroup; }
            overlayMaps[`<i class="fa-solid fa-map-pin" style="color:var(--accent-color);"></i> Мої точки`] = customPointsLayer;
            overlayMaps[`<i class="fa-solid fa-pencil" style="color:#f5a623;"></i> Малюнки`] = drawingsLayer
            mapLayersControl = L.control.layers(baseLayers, overlayMaps, { collapsed: false });
            mapLayersControl.addTo(map);
            document.getElementById('layers-container').appendChild(mapLayersControl.getContainer());
            Object.values(fileLayerGroups).forEach(group => map.addLayer(group));
            if (intersectionClusterGroup) map.addLayer(intersectionClusterGroup);
        }
        
        function drawObservation(log, layerGroup, isOverlay = false) {
            const originPoint = [log.originCoordinates.lat, log.originCoordinates.lon];
            const averageAzimuth = (parseAzimuth(log.azimuth)[0] + parseAzimuth(log.azimuth)[1]) / 2;
            const targetPoint = getDestPoint(originPoint[0], originPoint[1], averageAzimuth, log.distance);
            const polyline = L.polyline([originPoint, targetPoint], { color: log.fileColor, weight: 3, opacity: 0.9 }).addTo(layerGroup);
            const marker = L.circle(targetPoint, { color: log.fileColor, fillColor: log.fileColor, fillOpacity: 0.4, radius: 25 }).addTo(layerGroup);
            if (!isOverlay) {
                // marker.bindPopup(`<b>${log.name}</b><br><b>Дист:</b> ${log.distance} м`);
                 marker.on('click', () => { // ДОБАВЬТЕ ЭТОТ ОБРАБОТЧИК
                    openEventModal(log, targetPoint);
            });
                mapFeatures[log.uniqueId] = { marker, polyline };
            }
        }
        
        function filterForIntersection(logs) { return logs.filter(log => { if (!log.name || !log.azimuth || !log.distance) return false; const [startAz, endAz] = parseAzimuth(log.azimuth); return (endAz - startAz) <= 10; }); }
        function calculateAndDrawIntersections(logs) {
            intersectionClusterGroup = L.markerClusterGroup();
            for (let i = 0; i < logs.length; i++) { for (let j = i + 1; j < logs.length; j++) {
                const logA = logs[i], logB = logs[j]; if (logA.originCoordinates.lat === logB.originCoordinates.lat && logA.originCoordinates.lon === logB.originCoordinates.lon) continue;
                const iPoint = findIntersection(logA, logB);
                if (iPoint) {
                    const distA = calculateDistance(logA.originCoordinates.lat, logA.originCoordinates.lon, iPoint[0], iPoint[1]); const distB = calculateDistance(logB.originCoordinates.lat, logB.originCoordinates.lon, iPoint[0], iPoint[1]);
                    const popup = `<b>Перетин</b><br><b>Коорд:</b> ${iPoint[0].toFixed(5)}, ${iPoint[1].toFixed(5)}<hr><b>Файл 1:</b> ${logA.fileName}<br><b>Дист:</b> ${Math.round(distA)} м<br><hr><b>Файл 2:</b> ${logB.fileName}<br><b>Дист:</b> ${Math.round(distB)} м`;
                    const marker = L.marker(iPoint, { icon: L.divIcon({ className: 'fa-solid fa-crosshairs intersection-icon', iconSize: [24, 24] }) }).bindPopup(popup);
                    marker.feature = { type: "Feature", geometry: { type: "Point", coordinates: [iPoint[1], iPoint[0]] }, properties: { file1: logA.fileName, dist1: Math.round(distA), file2: logB.fileName, dist2: Math.round(distB) } };
                    intersectionClusterGroup.addLayer(marker);
                }
            }}
        }
        document.getElementById('export-button').addEventListener('click', () => {
            const layersToExport = [ ...Object.values(fileLayerGroups).flatMap(lg => lg.getLayers()), ...(intersectionClusterGroup ? intersectionClusterGroup.getLayers() : []), ...customPointsLayer.getLayers() ];
            if (layersToExport.length === 0) { return alert("Немає даних для експорту."); }
            const featureGroup = L.featureGroup(layersToExport); const geoJson = featureGroup.toGeoJSON();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geoJson, null, 2)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "map_data.geojson"); document.body.appendChild(dl); dl.click(); dl.remove();
        });
        function generateHslColor(index, total) { const hue = (index * (360 / total)) % 360; return `hsl(${hue}, 70%, 50%)`; }
        function parseAzimuth(az) { if (typeof az === 'string' && az.includes('-')) return az.split('-').map(Number); return [Number(az), Number(az)]; }
        function getDestPoint(lat, lon, brng, dist) { const R = 6371e3; const l1 = lat * Math.PI / 180, n1 = lon * Math.PI / 180, b = brng * Math.PI / 180; const l2 = Math.asin(Math.sin(l1) * Math.cos(dist / R) + Math.cos(l1) * Math.sin(dist / R) * Math.cos(b)); const n2 = n1 + Math.atan2(Math.sin(b) * Math.sin(dist / R) * Math.cos(l1), Math.cos(dist / R) - Math.sin(l1) * Math.sin(l2)); return [l2 * 180 / Math.PI, n2 * 180 / Math.PI]; }
        function findIntersection(logA, logB) { const azA = (parseAzimuth(logA.azimuth)[0] + parseAzimuth(logA.azimuth)[1]) / 2; const azB = (parseAzimuth(logB.azimuth)[0] + parseAzimuth(logB.azimuth)[1]) / 2; const p1 = logA.originCoordinates, p3 = logB.originCoordinates; const p2 = getDestPoint(p1.lat, p1.lon, azA, 10000), p4 = getDestPoint(p3.lat, p3.lon, azB, 10000); const x1 = p1.lon, y1 = p1.lat, x2 = p2[1], y2 = p2[0], x3 = p3.lon, y3 = p3.lat, x4 = p4[1], y4 = p4[0]; const den = (x1 - x2) * (y3 - y4) - (y1 - y2) * (x3 - x4); if (den === 0) return null; const t = ((x1 - x3) * (y3 - y4) - (y1 - y3) * (x3 - x4)) / den; const u = -((x1 - x2) * (y1 - y3) - (y1 - y2) * (x1 - x3)) / den; if (t > 0 && u > 0) return [y1 + t * (y2 - y1), x1 + t * (x2 - x1)]; return null; }
        function calculateDistance(lat1, lon1, lat2, lon2) { const R = 6371e3; const p1 = lat1 * Math.PI / 180, p2 = lat2 * Math.PI / 180; const dP = (lat2 - lat1) * Math.PI / 180; const dL = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(dP / 2) * Math.sin(dP / 2) + Math.cos(p1) * Math.cos(p2) * Math.sin(dL / 2) * Math.sin(dL / 2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return R * c; }

        // --- Запуск фоновой проверки ---
        window.addEventListener('load', () => {
            fetchDataFromSheet();
            setInterval(() => fetchDataFromSheet(true), 30000);
        });

        // --- ЛОГІКА МОДАЛЬНОГО ВІКНА ТА РИСУВАННЯ ---

const eventModalOverlay = document.getElementById('event-modal-overlay');

function openEventModal(log, coordinates) {
    currentModalLog = {log: log, coordinates: coordinates}; // Сохраняем данные для функций рисования
    
    // Заполняем окно данными
    document.getElementById('modal-title').textContent = log.name || 'Деталі події';
    document.getElementById('modal-coords').textContent = `${coordinates[0].toFixed(5)}, ${coordinates[1].toFixed(5)}`;
    const eventDate = new Date(log.timestamp);
    document.getElementById('modal-datetime').textContent = eventDate.toLocaleString('uk-UA', { dateStyle: 'medium', timeStyle: 'short' });
    document.getElementById('modal-comment').textContent = log.comment || 'Немає';

    // Показываем окно
    eventModalOverlay.classList.add('visible');
}

function closeModal() {
    eventModalOverlay.classList.remove('visible');
    currentModalLog = null;
    map.off('click'); // Отключаем все обработчики кликов на карте на всякий случай
    document.getElementById('map').classList.remove('map-placement-mode');
}

// Обработчики закрытия окна
document.getElementById('modal-close-button').addEventListener('click', closeModal);
eventModalOverlay.addEventListener('click', (e) => {
    if (e.target === eventModalOverlay) {
        closeModal();
    }
});

// Обработчики кнопок рисования
document.getElementById('modal-draw-arrow').addEventListener('click', () => startDrawing('arrow'));
document.getElementById('modal-draw-line').addEventListener('click', () => startDrawing('line'));

function startDrawing(type) {
    if (!currentModalLog) return;
    
    eventModalOverlay.classList.remove('visible'); // Скрываем окно для рисования
    document.getElementById('map').classList.add('map-placement-mode'); // Включаем курсор-крестик
    
    const startPoint = currentModalLog.coordinates;
    
    map.once('click', (e) => {
        const endPoint = e.latlng;
        const latlngs = [startPoint, [endPoint.lat, endPoint.lng]];
        
        let lineOptions = {
            color: currentModalLog.log.fileColor || '#ff0000',
            weight: 3
        };

        if (type === 'line') {
            lineOptions.dashArray = '5, 10'; // Штрих-пунктирная линия
        }

        const polyline = L.polyline(latlngs, lineOptions).addTo(drawingsLayer);

        if (type === 'arrow') {
            L.polylineDecorator(polyline, {
                patterns: [
                    { offset: '100%', repeat: 0, symbol: L.Symbol.arrowHead({ pixelSize: 15, polygon: false, pathOptions: { stroke: true, color: lineOptions.color } }) }
                ]
            }).addTo(drawingsLayer);
        }
        
        document.getElementById('map').classList.remove('map-placement-mode');
        currentModalLog = null;
    });
}
        
    </script>
</body>
</html>


