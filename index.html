<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ - –ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∞ –ø–∞–Ω–µ–ª—å</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro@2.9.6/build/vanilla-calendar.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <style>
        :root {
            --bg-color: rgba(255, 255, 255, 0.85);
            --blur-effect: backdrop-filter: blur(10px);
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --text-color: #2c2c2c;
            --accent-color: #007aff;
            --transition-speed: 0.3s;
        }

        html, body { height: 100%; margin: 0; padding: 0; font-family: 'Inter', sans-serif; color: var(--text-color); background-color: #eef1f4; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        
        #top-panel { position: absolute; top: 0; left: 0; right: 0; z-index: 1000; background: var(--bg-color); -webkit-backdrop-filter: var(--blur-effect); backdrop-filter: var(--blur-effect); border-bottom: 1px solid var(--border-color); box-shadow: 0 4px 20px var(--shadow-color); }
        .panel-header { padding: 0 20px; height: 55px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .panel-header h2 { margin: 0; font-size: 18px; }
        #panel-toggle-icon { transition: transform var(--transition-speed) ease; }
        #top-panel.collapsed #panel-toggle-icon { transform: rotate(-180deg); }
        
        .panel-content { max-height: 0; overflow: hidden; transition: max-height var(--transition-speed) ease-in-out; display: flex; padding: 0 10px; border-top: 1px solid transparent; }
        #top-panel:not(.collapsed) .panel-content { max-height: 50vh; padding: 10px; border-top-color: var(--border-color); }
        
        .panel-column { padding: 0 10px; height: calc(50vh - 20px); display: flex; flex-direction: column; }
        .panel-column h3 { margin: 0 0 10px 0; font-size: 16px; font-weight: 600; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); }
        #calendar-column { flex: 0 0 300px; }
        #events-column { flex: 1 1 40%; overflow-y: auto; }
        #layers-column { flex: 1 1 30%; }

        #action-buttons { display: flex; gap: 15px; }
        .action-button { background: none; border: none; font-size: 18px; cursor: pointer; color: var(--text-color); padding: 5px; position: relative; }
        
        #sync-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #ff3b30;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: translate(40%, -40%);
            display: none; 
        }
        
        #events-list { list-style: none; padding: 0; margin: 0; }
        #events-list li { padding: 10px 8px; font-size: 14px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; }
        #events-list li:hover, #events-list li.highlighted { background-color: rgba(0, 122, 255, 0.1); }
        .layer-legend-color { display: inline-block; width: 12px; height: 12px; margin-right: 8px; border-radius: 3px; vertical-align: middle;}

        #layers-container .leaflet-control-layers { border: none; box-shadow: none; background: transparent; }

        .map-placement-mode { cursor: crosshair !important; }
        .custom-point-popup input { border: 1px solid #ccc; padding: 8px; border-radius: 4px; width: calc(100% - 18px); }
        .custom-point-popup button { border: none; background: var(--accent-color); color: white; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-top: 8px; }
        .custom-point-popup p { margin: 5px 0; font-weight: bold; }
        
        #iframe-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            gap: 15px;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #iframe-overlay.visible { opacity: 1; visibility: visible; }

        .iframe-container { width: 95%; height: 85%; position: relative; }
        #deepstate-iframe { width: 100%; height: 100%; border: 1px solid var(--border-color); border-radius: 8px; background: #fff; }
        #leaflet-overlay-map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; background: transparent; pointer-events: none; }
        #leaflet-overlay-map .leaflet-tile-pane { opacity: 0; }
        
        #transfer-coords-button { padding: 12px 25px; font-size: 16px; font-weight: 600; background: var(--accent-color); color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 3000; display: flex; justify-content: center; align-items: center; }
        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid var(--accent-color); width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .intersection-icon { font-size: 24px !important; color: #d92f2f; text-shadow: 0 0 3px rgba(0,0,0,0.5); }


        /* --- –°–¢–ò–õ–Ü –ú–û–î–ê–õ–¨–ù–û–ì–û –í–Ü–ö–ù–ê --- */
#event-modal-overlay {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 2500;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0; visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}
#event-modal-overlay.visible {
    opacity: 1; visibility: visible;
}
#event-modal-content {
    background: var(--bg-color);
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 5px 25px var(--shadow-color);
    width: 90%;
    max-width: 500px;
    position: relative;
    -webkit-backdrop-filter: var(--blur-effect);
    backdrop-filter: var(--blur-effect);
}
.modal-close {
    position: absolute;
    top: 10px; right: 15px;
    font-size: 28px;
    font-weight: bold;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-color);
    opacity: 0.7;
    transition: opacity 0.2s;
}
.modal-close:hover { opacity: 1; }
#event-modal-content h3 {
    margin-top: 0;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
    margin-bottom: 15px;
}
#modal-info p { margin: 8px 0; }
#modal-info p strong { color: #555; }
#modal-actions {
    margin-top: 20px;
    display: flex;
    gap: 15px;
    border-top: 1px solid var(--border-color);
    padding-top: 15px;
}
#modal-actions button {
    border: none;
    background: var(--accent-color);
    color: white;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: background-color 0.2s;
}
#modal-actions button:hover {
    background-color: #0056b3;
}


/* --- –°–¢–ò–õ–Ü –ú–û–î–ê–õ–¨–ù–û–ì–û –í–Ü–ö–ù–ê –î–õ–Ø –ú–ê–õ–Æ–í–ê–ù–ù–Ø --- */
/* –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–ª–∞—Å–∏, —Å—Ö–æ–∂—ñ –Ω–∞ –≤–∂–µ —ñ—Å–Ω—É—é—á—ñ, —â–æ–± —É—Å–ø–∞–¥–∫—É–≤–∞—Ç–∏ —Å—Ç–∏–ª—ñ */
.event-modal-overlay-custom {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 2500;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0; visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}
.event-modal-overlay-custom.visible {
    opacity: 1; visibility: visible;
}
.event-modal-content-custom {
    background: var(--bg-color);
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 5px 25px var(--shadow-color);
    width: 90%;
    max-width: 600px; /* –¢—Ä–æ—Ö–∏ —à–∏—Ä—à–µ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
    position: relative;
    -webkit-backdrop-filter: var(--blur-effect);
    backdrop-filter: var(--blur-effect);
}
.modal-close-custom {
    position: absolute;
    top: 10px; right: 15px;
    font-size: 28px;
    font-weight: bold;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-color);
    opacity: 0.7;
    transition: opacity 0.2s;
}
.modal-close-custom:hover { opacity: 1; }
.event-modal-content-custom h3 {
    margin-top: 0;
    text-align: center;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
    margin-bottom: 15px;
}

/* –°—Ç–∏–ª—ñ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤–∏–±–æ—Ä—É —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É */
#drawing-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞ —Å—ñ—Ç–∫–∞ */
    gap: 15px;
    margin-top: 20px;
}
.draw-option-button {
    background-color: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    padding: 15px;
    cursor: pointer;
    font-size: 14px;
    font-family: 'Inter', sans-serif;
    color: var(--text-color);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: background-color 0.2s, transform 0.2s;
    text-align: center;
}
.draw-option-button:hover {
    background-color: rgba(0, 122, 255, 0.1);
    border-color: var(--accent-color);
    transform: translateY(-2px);
}
.draw-option-button i {
    font-size: 24px;
    color: var(--accent-color);
}


.color-picker-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding: 10px;
    background-color: rgba(0,0,0,0.05);
    border-radius: 8px;
}
.color-picker-container label {
    font-weight: 500;
}
#drawing-color-picker {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 40px;
    height: 40px;
    background-color: transparent;
    border: none;
    cursor: pointer;
}
#drawing-color-picker::-webkit-color-swatch {
    border-radius: 50%;
    border: 2px solid rgba(0,0,0,0.2);
}
#drawing-color-picker::-moz-color-swatch {
    border-radius: 50%;
    border: 2px solid rgba(0,0,0,0.2);
}


/* --- –°–¢–ò–õ–Ü –î–õ–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –í–Ü–ö–ù–ê –°–¢–í–û–†–ï–ù–ù–Ø –¢–û–ß–ö–ò --- */
#custom-point-modal-content .form-group {
    margin-bottom: 15px;
}
#custom-point-modal-content label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    font-size: 14px;
}
#custom-point-modal-content input[type="text"],
#custom-point-modal-content input[type="file"] {
    width: calc(100% - 20px);
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
}
#custom-point-modal-content .source-toggle {
    display: flex;
    gap: 20px;
    justify-content: space-around;
    background-color: rgba(0,0,0,0.05);
    padding: 8px;
    border-radius: 6px;
}
#place-point-submit {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    font-weight: 600;
    border: none;
    background: var(--accent-color);
    color: white;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 15px;
    transition: background-color 0.2s;
}
#place-point-submit:hover {
    background-color: #0056b3;
}

        
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="top-panel" class="collapsed">
        <div class="panel-header" id="panel-header-toggle">
            <h2>–ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∞ –ø–∞–Ω–µ–ª—å</h2>
            <div id="action-buttons">
                <button id="sync-button" class="action-button" title="–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –∑ Google Sheet">
                    <i class="fa-solid fa-sync"></i>
                    <span id="sync-badge"></span>
                </button>
                <button id="deepstate-button" class="action-button" title="–ù–∞–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ DeepState Map"><i class="fa-solid fa-layer-group"></i></button>
                <button id="add-point-button" class="action-button" title="–î–æ–¥–∞—Ç–∏ –≤–ª–∞—Å–Ω—É —Ç–æ—á–∫—É"><i class="fa-solid fa-map-pin"></i></button>
                <button id="draw-button" class="action-button" title="–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –º–∞–ª—é–≤–∞–Ω–Ω—è"><i class="fa-solid fa-pencil-ruler"></i></button>
                <button id="gps-button" class="action-button" title="–ó–Ω–∞–π—Ç–∏ –º–æ—î –º—ñ—Å—Ü–µ–ø–æ–ª–æ–∂–µ–Ω–Ω—è"><i class="fa-solid fa-location-crosshairs"></i></button>
                <button id="upload-button" class="action-button" title="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ª–æ–≥–∏"><i class="fa-solid fa-upload"></i></button>
                <button id="export-button" class="action-button" title="–ï–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä–µ—Ç–∏–Ω—ñ–≤ (GeoJSON)"><i class="fa-solid fa-file-export"></i></button>
                <i class="fa-solid fa-chevron-down" id="panel-toggle-icon" style="margin-left: 20px;"></i>
            </div>
        </div>
        <div class="panel-content">
            <div class="panel-column" id="calendar-column"><h3>–ö–∞–ª–µ–Ω–¥–∞—Ä</h3><div id="calendar-container"></div></div>
            <div class="panel-column" id="events-column"><h3 id="events-list-title">–ü–æ–¥—ñ—ó</h3><ul id="events-list"></ul></div>
            <div class="panel-column" id="layers-column"><h3>–®–∞—Ä–∏ –∫–∞—Ä—Ç–∏</h3><div id="layers-container"></div></div>
        </div>
    </div>
    
    <div id="iframe-overlay">
        <div class="iframe-container">
            <iframe id="deepstate-iframe" src="https://deepstatemap.live" frameborder="0"></iframe>
            <div id="leaflet-overlay-map"></div>
        </div>
        <button id="transfer-coords-button">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ —Ç–∞ –∑–∞–∫—Ä–∏—Ç–∏</button>
    </div>
    
    <input type="file" id="log-file-input" multiple accept=".json" style="display: none;">
    <div id="loader-overlay" class="hidden" style="display:none;"><div class="loader"></div></div>

    <div id="event-modal-overlay">
    <div id="event-modal-content">
        <button id="modal-close-button" class="modal-close">&times;</button>
        <h3 id="modal-title">–î–µ—Ç–∞–ª—ñ –ø–æ–¥—ñ—ó</h3>
        <div id="modal-info">
            <p><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:</strong> <span id="modal-coords"></span></p>
            <p><strong>–ß–∞—Å –ø–æ–¥—ñ—ó:</strong> <span id="modal-datetime"></span></p>
            <p><strong>–ö–æ–º–µ–Ω—Ç–∞—Ä:</strong> <span id="modal-comment"></span></p>
        </div>
        <div id="modal-actions">
            <button id="modal-draw-arrow">–ù–∞–º–∞–ª—é–≤–∞—Ç–∏ —Å—Ç—Ä—ñ–ª–∫—É</button>
            <button id="modal-draw-line">–ù–∞–º–∞–ª—é–≤–∞—Ç–∏ –ª—ñ–Ω—ñ—é</button>
        </div>
    </div>
</div>


<div id="drawing-modal-overlay" class="event-modal-overlay-custom">
  <div id="drawing-modal-content" class="event-modal-content-custom">
    <button id="drawing-modal-close-button" class="modal-close-custom">&times;</button>
    <h3>–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –º–∞–ª—é–≤–∞–Ω–Ω—è</h3>
    <p style="text-align: center; margin-top: -10px; opacity: 0.7;">–û–±–µ—Ä—ñ—Ç—å —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –∫–æ–ª—ñ—Ä, –∞ –ø–æ—Ç—ñ–º –∫–ª–∞—Ü–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç—ñ –¥–ª—è –º–∞–ª—é–≤–∞–Ω–Ω—è.</p>
    
    <div class="color-picker-container">
        <label for="drawing-color-picker">–ö–æ–ª—ñ—Ä:</label>
        <input type="color" id="drawing-color-picker" value="#ff4747">
    </div>

    <div id="drawing-options">
        <button class="draw-option-button" data-draw-type="arrow">
            <i class="fa-solid fa-arrow-right"></i>
            <span>–°—Ç—Ä—ñ–ª–∫–∞</span>
        </button>
        <button class="draw-option-button" data-draw-type="repeating-arrow">
            <i class="fa-solid fa-angles-right"></i>
            <span>–ü–æ–≤—Ç–æ—Ä. —Å—Ç—Ä—ñ–ª–∫–∏</span>
        </button>
        <button class="draw-option-button" data-draw-type="animated-arrow"> <i class="fa-solid fa-play"></i>
            <span>–ê–Ω—ñ–º–æ–≤–∞–Ω–∞ —Å—Ç—Ä—ñ–ª–∫–∞</span>
        </button>
        <button class="draw-option-button" data-draw-type="flexible-line"> <i class="fa-solid fa-wave-square"></i>
            <span>–í–∏–≥–Ω—É—Ç–∞ –ª—ñ–Ω—ñ—è</span>
        </button>
        <button class="draw-option-button" data-draw-type="dashed-line">
            <i class="fa-solid fa-grip-lines"></i>
            <span>–ü—É–Ω–∫—Ç–∏—Ä</span>
        </button>
        <button class="draw-option-button" data-draw-type="animated-ants">
            <i class="fa-solid fa-person-running"></i>
            <span>–ê–Ω—ñ–º–æ–≤–∞–Ω–∏–π –ø—É–Ω–∫—Ç–∏—Ä</span>
        </button>
        <button class="draw-option-button" data-draw-type="icon-line"> <i class="fa-solid fa-location-dot"></i>
            <span>–õ—ñ–Ω—ñ—è –∑ —ñ–∫–æ–Ω–∫–∞–º–∏</span>
        </button>
    </div>
</div>
</div>


<div id="custom-point-modal-overlay" class="event-modal-overlay-custom">
    <div id="custom-point-modal-content" class="event-modal-content-custom" style="max-width: 450px;">
        <button id="custom-point-modal-close-button" class="modal-close-custom">&times;</button>
        <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —Ç–æ—á–∫–∏</h3>
        
        <div class="form-group">
            <label for="point-name-input">–ù–∞–∑–≤–∞:</label>
            <input type="text" id="point-name-input" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, '–ü–æ–∑–∏—Ü—ñ—è 1'">
        </div>

        <div class="form-group">
            <label>–Ü–∫–æ–Ω–∫–∞:</label>
            <div class="source-toggle">
                <label><input type="radio" name="point-icon-source" value="default" checked> –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞</label>
                <label><input type="radio" name="point-icon-source" value="url"> URL</label>
                <label><input type="radio" name="point-icon-source" value="file"> –§–∞–π–ª</label>
            </div>
        </div>

        <div id="point-url-source-group" class="form-group" style="display: none;">
            <label for="point-url-input">–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —ñ–∫–æ–Ω–∫—É:</label>
            <input type="text" id="point-url-input" placeholder="https://example.com/icon.png">
        </div>

        <div id="point-file-source-group" class="form-group" style="display: none;">
            <label for="point-file-input">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª (PNG, JPG, SVG):</label>
            <input type="file" id="point-file-input" accept="image/*">
        </div>

        <button id="place-point-submit">–†–æ–∑–º—ñ—Å—Ç–∏—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç—ñ</button>
    </div>
</div>
    
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanilla-calendar-pro@2.9.6/build/vanilla-calendar.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWLzQoJq0hfHer7Vsdk2xJe_Z7aNA4SRhiU0NWkMPv3IZAdcMFkyH-GrkXm6WK5SEZ/exec'; 

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã ---
        const map = L.map('map', { zoomControl: false }).setView([50.41, 30.64], 11);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        const baseLayers = {
            "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }),
            "–°—É–ø—É—Ç–Ω–∏–∫": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri' }),
        };
        baseLayers["–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞"].addTo(map);
        
             // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        let allLogsData = [], calendar, mapLayersControl, fileLayerGroups = {}, intersectionClusterGroup, selectedCalendarDate = null;
        let mapFeatures = {};
        let customPointsLayer = L.layerGroup().addTo(map);
        let overlayMap = null; 
        let overlayLayersGroup = L.layerGroup();
        let lastSyncRowCount = 0; 
        let drawingsLayer = L.layerGroup().addTo(map); // <-- –î–û–ë–ê–í–ò–¢–¨ –≠–¢–û
        let currentModalLog = null; // <-- –ò –≠–¢–û
        

        // --- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ DOM ---
        const loader = document.getElementById('loader-overlay');
        const logFileInput = document.getElementById('log-file-input');
        const iframeOverlay = document.getElementById('iframe-overlay');


        // --- –õ–û–ì–Ü–ö–ê –ú–û–î–ê–õ–¨–ù–û–ì–û –í–Ü–ö–ù–ê –ú–ê–õ–Æ–í–ê–ù–ù–Ø ---

const drawingModalOverlay = document.getElementById('drawing-modal-overlay');
const drawingOptions = document.getElementById('drawing-options');

// 1. –í—ñ–¥–∫—Ä–∏—Ç—Ç—è —Ç–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
document.getElementById('draw-button').addEventListener('click', () => {
    drawingModalOverlay.classList.add('visible');
});

function closeDrawingModal() {
    drawingModalOverlay.classList.remove('visible');
}

document.getElementById('drawing-modal-close-button').addEventListener('click', closeDrawingModal);
drawingModalOverlay.addEventListener('click', (e) => {
    if (e.target === drawingModalOverlay) {
        closeDrawingModal();
    }
});

// 2. –û–±—Ä–æ–±–∫–∞ –∫–ª—ñ–∫—É –Ω–∞ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –º–∞–ª—é–≤–∞–Ω–Ω—è
drawingOptions.addEventListener('click', (e) => {
    const button = e.target.closest('.draw-option-button');
    if (!button) return;

    const drawType = button.dataset.drawType;
    closeDrawingModal();
    initiateDrawing(drawType);
});

// 3. –§—É–Ω–∫—Ü—ñ—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –º–∞–ª—é–≤–∞–Ω–Ω—è –Ω–∞ –∫–∞—Ä—Ç—ñ (2 –∫–ª—ñ–∫–∏)
// --- –û–ù–û–í–õ–ï–ù–ê –õ–û–ì–Ü–ö–ê –ú–ê–õ–Æ–í–ê–ù–ù–Ø ---

// –û–±—Ä–æ–±–∫–∞ –∫–ª—ñ–∫—É –Ω–∞ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –º–∞–ª—é–≤–∞–Ω–Ω—è
drawingOptions.addEventListener('click', (e) => {
    const button = e.target.closest('.draw-option-button');
    if (!button) return;

    const drawType = button.dataset.drawType;
    closeDrawingModal();
    
    // –î–ª—è –≤–∏–≥–Ω—É—Ç–æ—ó –ª—ñ–Ω—ñ—ó –ø–æ—Ç—Ä—ñ–±–µ–Ω —ñ–Ω—à–∏–π –ø—Ä–æ—Ü–µ—Å (3 –∫–ª—ñ–∫–∏)
    if (drawType === 'flexible-line') {
        initiateFlexibleDrawing(drawType);
    } else {
        initiateStandardDrawing(drawType);
    }
});

// 1. –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –º–∞–ª—é–≤–∞–Ω–Ω—è (2 –∫–ª—ñ–∫–∏)
function initiateStandardDrawing(drawType) {
    document.getElementById('map').classList.add('map-placement-mode');
    
    map.once('click', (e1) => {
        const startPoint = e1.latlng;
        const startMarker = L.circleMarker(startPoint, { color: 'var(--accent-color)', radius: 5, weight: 2 }).addTo(map);

        map.once('click', (e2) => {
            const endPoint = e2.latlng;
            drawDecoratedPolyline([startPoint, endPoint], drawType); // –ü–µ—Ä–µ–¥–∞—î–º–æ –º–∞—Å–∏–≤ —Ç–æ—á–æ–∫
            document.getElementById('map').classList.remove('map-placement-mode');
            map.removeLayer(startMarker);
        });
    });
}

// 2. „Ä∞Ô∏è –ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–≥–Ω—É—Ç–æ—ó –ª—ñ–Ω—ñ—ó (3 –∫–ª—ñ–∫–∏)
function initiateFlexibleDrawing(drawType) {
    document.getElementById('map').classList.add('map-placement-mode');
    const points = [];
    const tempMarkers = L.layerGroup().addTo(map);

    const instructionText = '–ö–ª—ñ–∫–Ω—ñ—Ç—å, —â–æ–± –¥–æ–¥–∞—Ç–∏ –ø—Ä–æ–º—ñ–∂–Ω—É —Ç–æ—á–∫—É';
    // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ø–æ–∫–∞–∑ –ø—ñ–¥–∫–∞–∑–∫–∏ –Ω–∞ –µ–∫—Ä–∞–Ω—ñ

    // –ü–µ—Ä—à–∏–π –∫–ª—ñ–∫ (—Å—Ç–∞—Ä—Ç)
    map.once('click', (e1) => {
        points.push(e1.latlng);
        tempMarkers.addLayer(L.circleMarker(e1.latlng, { color: 'var(--accent-color)', radius: 5, weight: 2 }));

        // –î—Ä—É–≥–∏–π –∫–ª—ñ–∫ (–≤–∏–≥–∏–Ω)
        map.once('click', (e2) => {
            points.push(e2.latlng);
            tempMarkers.addLayer(L.circleMarker(e2.latlng, { color: 'var(--accent-color)', radius: 5, weight: 2 }));

            // –¢—Ä–µ—Ç—ñ–π –∫–ª—ñ–∫ (–∫—ñ–Ω–µ—Ü—å)
            map.once('click', (e3) => {
                points.push(e3.latlng);
                drawDecoratedPolyline(points, drawType);
                document.getElementById('map').classList.remove('map-placement-mode');
                tempMarkers.clearLayers();
            });
        });
    });
}


// 3. üöÄ –ü–æ–≤–Ω—ñ—Å—Ç—é –æ–Ω–æ–≤–ª–µ–Ω–∞ –≥–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –º–∞–ª—é–≤–∞–Ω–Ω—è
function drawDecoratedPolyline(latlngs, type) {
    // üé® –ó—á–∏—Ç—É—î–º–æ –æ–±—Ä–∞–Ω–∏–π –∫–æ–ª—ñ—Ä
    const selectedColor = document.getElementById('drawing-color-picker').value;

    let polyline;
    if (type === 'flexible-line') {
        // –î–ª—è –ø–ª–∞–≤–Ω–æ—ó –∫—Ä–∏–≤–æ—ó –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–ª–∞–≥—ñ–Ω (—è–∫—â–æ –≤—ñ–Ω —î) –∞–±–æ –ø—Ä–æ—Å—Ç–æ –ª–∞–º–∞–Ω—É –ª—ñ–Ω—ñ—é
        // –£ –Ω–∞—à–æ–º—É –≤–∏–ø–∞–¥–∫—É —Ü–µ –±—É–¥–µ –ø—Ä–æ—Å—Ç–æ –ª—ñ–Ω—ñ—è –∑ 3 —Ç–æ—á–æ–∫.
        polyline = L.polyline(latlngs, { color: selectedColor, weight: 3, interactive: false }).addTo(drawingsLayer);
    } else {
         polyline = L.polyline(latlngs, { color: selectedColor, weight: 3 }).addTo(drawingsLayer);
    }


    switch (type) {
        case 'arrow':
            L.polylineDecorator(polyline, {
                patterns: [{
                    offset: '100%',
                    symbol: L.Symbol.arrowHead({ pixelSize: 15, pathOptions: { stroke: true, color: selectedColor } })
                }]
            }).addTo(drawingsLayer);
            break;

        case 'repeating-arrow':
            L.polylineDecorator(polyline, {
                patterns: [{
                    repeat: 80,
                    symbol: L.Symbol.arrowHead({ pixelSize: 12, pathOptions: { color: selectedColor, fillOpacity: 1, weight: 0 }})
                }]
            }).addTo(drawingsLayer);
            break;

        case 'animated-arrow': // üöÄ –ù–û–í–ê –õ–û–ì–Ü–ö–ê
             const animatedArrowDecorator = L.polylineDecorator(polyline, {
                patterns: [{
                    offset: 0, repeat: 150,
                    symbol: L.Symbol.arrowHead({ pixelSize: 12, pathOptions: { color: selectedColor, fillOpacity: 1, weight: 0 }})
                }]
            }).addTo(drawingsLayer);

            let arrowOffset = 0;
            setInterval(() => {
                arrowOffset = (arrowOffset + 1) % 150;
                animatedArrowDecorator.setPatterns([{
                    offset: arrowOffset, repeat: 150,
                    symbol: L.Symbol.arrowHead({ pixelSize: 12, pathOptions: { color: selectedColor, fillOpacity: 1, weight: 0 }})
                }]);
            }, 50); // –®–≤–∏–¥–∫—ñ—Å—Ç—å –∞–Ω—ñ–º–∞—Ü—ñ—ó
            break;
            
        case 'dashed-line':
            polyline.setStyle({ dashArray: '10, 10' });
            break;

        case 'animated-ants':
            // –†–æ–±–∏–º–æ —Ñ–æ–Ω –ª—ñ–Ω—ñ—ó —Ç—Ä–æ—Ö–∏ –ø—Ä–æ–∑–æ—Ä–∏–º, —â–æ–± –∞–Ω—ñ–º–∞—Ü—ñ—è –±—É–ª–∞ –ø–æ–º—ñ—Ç–Ω—ñ—à–æ—é
            polyline.setStyle({ color: selectedColor, opacity: 0.5 });
            const decorator = L.polylineDecorator(polyline, {
                patterns: [{
                    offset: 0, repeat: '20px',
                    symbol: L.Symbol.dash({ pixelSize: 10, pathOptions: { color: 'white', weight: 2, opacity: 0.9 }})
                }]
            }).addTo(drawingsLayer);

            let offset = 0;
            setInterval(() => {
                offset = (offset + 1) % 20;
                decorator.setPatterns([{
                    offset: offset, repeat: '20px',
                    symbol: L.Symbol.dash({ pixelSize: 10, pathOptions: { color: 'white', weight: 2, opacity: 0.9 }})
                }]);
            }, 100);
            break;

        case 'icon-line': // üìç –ù–û–í–ê –õ–û–ì–Ü–ö–ê
            // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–∞—Å—Ç–æ–º–Ω—É —ñ–∫–æ–Ω–∫—É
            const customIcon = L.icon({
                iconUrl: 'https://img.icons8.com/color/48/marker.png', // <-- –ó–ê–ú–Ü–ù–Ü–¢–¨ –ù–ê URL –í–ê–®–û–á –Ü–ö–û–ù–ö–ò
                iconSize: [32, 32],   // –†–æ–∑–º—ñ—Ä 32x32
                iconAnchor: [16, 32], // "–ù—ñ–∂–∫–∞" —ñ–∫–æ–Ω–∫–∏ –±—É–¥–µ —Ç–æ—á–Ω–æ –Ω–∞ –ª—ñ–Ω—ñ—ó
            });

            L.polylineDecorator(polyline, {
                patterns: [
                    {
                        repeat: 150, // –í—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ —ñ–∫–æ–Ω–∫–∞–º–∏ –≤ –ø—ñ–∫—Å–µ–ª—è—Ö
                        symbol: L.Symbol.marker({
                            markerOptions: {
                                icon: customIcon
                            }
                        })
                    }
                ]
            }).addTo(drawingsLayer);
            break;
    }
}


        
        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º ---
        document.getElementById('panel-header-toggle').addEventListener('click', (e) => {
            if (e.target.closest('.action-button')) return;
            document.getElementById('top-panel').classList.toggle('collapsed');
        });

        // --- –ü—Ä–∏–≤—è–∑–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π –∫ –∫–Ω–æ–ø–∫–∞–º ---
        document.getElementById('gps-button').addEventListener('click', () => {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude, lon = pos.coords.longitude, zoom = 13;
                map.flyTo([lat, lon], zoom);
                const deepstateIframe = document.getElementById('deepstate-iframe');
                deepstateIframe.src = `https://deepstatemap.live/#${zoom}/${lat.toFixed(5)}/${lon.toFixed(5)}`;
            }, () => alert("–ü–æ–º–∏–ª–∫–∞ GPS"));
        });

        document.getElementById('upload-button').addEventListener('click', () => logFileInput.click());
        logFileInput.addEventListener('change', handleFileSelect);
        document.getElementById('add-point-button').addEventListener('click', () => {
    document.getElementById('custom-point-modal-overlay').classList.add('visible');
});
        
        // --- DeepState Map –æ–≤–µ—Ä–ª–µ–π ---
        document.getElementById('deepstate-button').addEventListener('click', () => {
            const center = map.getCenter(); const zoom = map.getZoom();
            document.getElementById('deepstate-iframe').src = `https://deepstatemap.live/#${zoom}/${center.lat.toFixed(5)}/${center.lng.toFixed(5)}`;
            iframeOverlay.classList.add('visible');
            if (!overlayMap) {
                overlayMap = L.map('leaflet-overlay-map', { zoomControl: false, attributionControl: false, layers: [overlayLayersGroup] });
            }
            overlayMap.setView(center, zoom);
            populateOverlayMap();
        });
        document.getElementById('transfer-coords-button').addEventListener('click', () => {
            iframeOverlay.classList.remove('visible');
            document.getElementById('map').classList.add('map-placement-mode');
            map.once('click', (e) => {
                createCustomPoint(e.latlng, '–¢–æ—á–∫–∞ –∑ DeepState');
                document.getElementById('map').classList.remove('map-placement-mode');
            });
        });

        function populateOverlayMap() {
            overlayLayersGroup.clearLayers();
            let filteredLogs = allLogsData.filter(log => !selectedCalendarDate || log.timestamp.startsWith(selectedCalendarDate));
            filteredLogs.forEach(log => { if (log.azimuth && log.distance) { drawObservation(log, overlayLayersGroup, true); } });
            if (intersectionClusterGroup) {
                intersectionClusterGroup.getLayers().forEach(marker => { L.marker(marker.getLatLng(), { icon: marker.options.icon }).bindPopup(marker.getPopup().getContent()).addTo(overlayLayersGroup); });
            }
            customPointsLayer.getLayers().forEach(marker => {
                const newMarker = L.marker(marker.getLatLng(), { icon: marker.options.icon }).addTo(overlayLayersGroup);
                if (marker.customName) { newMarker.bindPopup(getPopupContent({_leaflet_id: 'clone', customName: marker.customName, getLatLng: marker.getLatLng})); }
            });
        }


        // --- –†–∞–±–æ—Ç–∞ —Å Google Sheets ---
        document.getElementById('sync-button').addEventListener('click', () => fetchDataFromSheet(false)); // false = –Ω–µ —Ç–∏—Ö–∏–π —Ä–µ–∂–∏–º

        async function fetchDataFromSheet(isSilent = false) {
            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                if (!isSilent) alert('–ü–æ–º–∏–ª–∫–∞: URL Google Apps Script –Ω–µ –≤–∫–∞–∑–∞–Ω–æ –≤ –∫–æ–¥—ñ.');
                return;
            }
            if (!isSilent) loader.style.display = 'flex';
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                const sheetData = await response.json();
                
                if (isSilent) {
                    const newRowCount = sheetData.length;
                    const newEventsCount = newRowCount - lastSyncRowCount;
                    const syncBadge = document.getElementById('sync-badge');
                    if (newEventsCount > 0) {
                        syncBadge.textContent = newEventsCount;
                        syncBadge.style.display = 'flex';
                    } else {
                        syncBadge.style.display = 'none';
                    }
                    return;
                }

                lastSyncRowCount = sheetData.length;
                document.getElementById('sync-badge').style.display = 'none';

                const formattedData = sheetData.map((row, index) => {
                    return {
                        name: row.Event, timestamp: row.Timestamp, azimuth: row.Azimuth,
                        distance: row.Distance ? parseInt(row.Distance, 10) : null,
                        comment: row.Comment, uniqueId: row.UniqueID || `sheet_${index}`,
                        originCoordinates: { lat: parseFloat(row.Latitude), lon: parseFloat(row.Longitude) },
                        fileName: `Sheet: ${row.Shift} | ${row.Position}`,
                        fileColor: generateHslColor(index, sheetData.length)
                    };
                });
                
                allLogsData = formattedData;
                initCalendar(); updateMap(); displayEventsList(allLogsData, null);
                
            } catch (error) {
                if (!isSilent) alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∑ Google Sheet.');
                console.error('Fetch error:', error);
            } finally {
                if (!isSilent) loader.style.display = 'none';
            }
        }
        
        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ ---
        function handleFileSelect(event) {
            loader.style.display = 'flex';
            if (mapLayersControl) { map.removeControl(mapLayersControl); mapLayersControl = null; }
            Object.values(fileLayerGroups).forEach(group => group.clearLayers());
            if (intersectionClusterGroup) intersectionClusterGroup.clearLayers();
            allLogsData = []; fileLayerGroups = {}; mapFeatures = {};
            let logIdCounter = 0;
            const files = Array.from(event.target.files);
            const promises = files.map((file, index) => new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result); let processedLogs = [];
                        if (data.events && data.position && data.position.location) {
                            const originCoordinates = { lat: data.position.location.lat, lon: data.position.location.lon };
                            data.events.forEach(event => { processedLogs.push({ ...event, distance: event.distance ? parseInt(event.distance, 10) : null, uniqueId: `log_${logIdCounter++}`, originCoordinates: originCoordinates, fileName: file.name, fileColor: generateHslColor(index, files.length) }); });
                        } else if (data.logs && data.originCoordinates) {
                            data.logs.forEach(log => { log.uniqueId = `log_${logIdCounter++}`; log.originCoordinates = data.originCoordinates; log.fileName = file.name; log.fileColor = generateHslColor(index, files.length); processedLogs.push(log); });
                        } else { alert(`–§–∞–π–ª ${file.name} –º–∞—î –Ω–µ–≤—ñ–¥–æ–º–∏–π —Ñ–æ—Ä–º–∞—Ç.`); }
                        allLogsData.push(...processedLogs);
                    } catch (error) { alert(`–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É —Ñ–∞–π–ª—É ${file.name}.`); console.error(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ ${file.name}:`, error); }
                    resolve();
                };
                reader.readAsText(file);
            }));
            Promise.all(promises).then(() => {
                initCalendar(); updateMap(); displayEventsList(allLogsData, null);
                document.getElementById('top-panel').classList.remove('collapsed');
                loader.style.display = 'none';
            });
        }
        
        // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã ---
        function updateMap() {
            if (mapLayersControl) { map.removeControl(mapLayersControl); mapLayersControl = null; }
            Object.values(fileLayerGroups).forEach(group => group.clearLayers());
            if (intersectionClusterGroup) { intersectionClusterGroup.clearLayers(); map.removeLayer(intersectionClusterGroup); }
            fileLayerGroups = {}; mapFeatures = {};
            let filteredLogs = allLogsData.filter(log => !selectedCalendarDate || log.timestamp.startsWith(selectedCalendarDate));
            drawLogVisuals(filteredLogs);
            calculateAndDrawIntersections(filterForIntersection(filteredLogs));
        }
        
        // --- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π ---
        function initCalendar() {
            const eventDates = [...new Set(allLogsData.map(log => log.timestamp.substring(0, 10)))];
            const options = {
                actions: { clickDay(e, self) {
                    selectedCalendarDate = self.selectedDates[0] || null;
                    const eventsForDate = selectedCalendarDate ? allLogsData.filter(log => log.timestamp.startsWith(selectedCalendarDate)) : allLogsData;
                    displayEventsList(eventsForDate, selectedCalendarDate);
                    updateMap();
                }},
                settings: { visibility: { highlighted: eventDates } },
            };
            if (calendar) calendar.destroy();
            calendar = new VanillaCalendar('#calendar-container', options);
            calendar.init();
        }
        function displayEventsList(events, date) {
            const list = document.getElementById('events-list'); list.innerHTML = '';
            document.getElementById('events-list-title').textContent = date ? `–ü–æ–¥—ñ—ó –∑–∞ ${date}` : '–í—Å—ñ –ø–æ–¥—ñ—ó';
            if (events.length === 0) { list.innerHTML = '<li>–ù–µ–º–∞—î –ø–æ–¥—ñ–π.</li>'; return; }
            events.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            events.forEach(log => {
                const time = new Date(log.timestamp).toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
                const li = document.createElement('li'); li.dataset.logId = log.uniqueId;
                li.innerHTML = `<span class="layer-legend-color" style="background-color: ${log.fileColor};"></span><span><b>${log.name || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</b> (${log.distance || 'N/A'}m) <small style="opacity:0.7;">- ${time}</small></span>`;
                list.appendChild(li);
            });
        }

        // --- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–ø–∏—Å–∫–∞ –∏ –∫–∞—Ä—Ç—ã ---
        const eventsListElement = document.getElementById('events-list');
        eventsListElement.addEventListener('mouseover', (e) => {
            const li = e.target.closest('li'); if (!li || !li.dataset.logId) return;
            document.querySelectorAll('#events-list li').forEach(el => el.classList.remove('highlighted'));
            li.classList.add('highlighted');
            const feature = mapFeatures[li.dataset.logId];
            if (feature && feature.polyline) { feature.polyline.setStyle({ weight: 7 }); }
        });
        eventsListElement.addEventListener('mouseout', (e) => {
            document.querySelectorAll('#events-list li').forEach(el => el.classList.remove('highlighted'));
            Object.values(mapFeatures).forEach(feature => {
                if (feature.polyline) { feature.polyline.setStyle({ weight: 3 }); }
            });
        });
        eventsListElement.addEventListener('click', (e) => {
            const li = e.target.closest('li'); if (!li || !li.dataset.logId) return;
            const feature = mapFeatures[li.dataset.logId];
            if (feature && feature.marker) { map.flyTo(feature.marker.getLatLng(), 15); feature.marker.openPopup(); }
        });
        
        function drawLogVisuals(logsToDraw) {
            const overlayMaps = {}; const logsByFile = logsToDraw.reduce((acc, log) => { if (!acc[log.fileName]) acc[log.fileName] = []; acc[log.fileName].push(log); return acc; }, {});
            for (const fileName in logsByFile) {
                const logs = logsByFile[fileName]; if (logs.length === 0) continue;
                const fileColor = logs[0].fileColor; const fileGroup = L.layerGroup(); const originsDrawn = new Set();
                logs.forEach(log => {
                    const origin = log.originCoordinates; if (!originsDrawn.has(`${origin.lat},${origin.lon}`)) {
                        L.marker([origin.lat, origin.lon], { icon: L.divIcon({ className: 'fa-solid fa-user-secret', iconSize: [20, 20], html: `<i class="fa-solid fa-user-secret" style="color: ${fileColor}; font-size: 20px;"></i>` }) }).addTo(fileGroup).bindPopup(`<b>–°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á</b><br>${fileName}`);
                        originsDrawn.add(`${origin.lat},${origin.lon}`);
                    }
                    if (log.azimuth && log.distance) drawObservation(log, fileGroup);
                });
                fileLayerGroups[fileName] = fileGroup; overlayMaps[`<span class="layer-legend-color" style="background-color:${fileColor};"></span> ${fileName.substring(0, 25)}...`] = fileGroup;
            }
            if (intersectionClusterGroup && intersectionClusterGroup.getLayers().length > 0) { overlayMaps[`<i class="fa-solid fa-crosshairs" style="color:#d92f2f;"></i> –ü–µ—Ä–µ—Ç–∏–Ω–∏`] = intersectionClusterGroup; }
            overlayMaps[`<i class="fa-solid fa-map-pin" style="color:var(--accent-color);"></i> –ú–æ—ó —Ç–æ—á–∫–∏`] = customPointsLayer;
            overlayMaps[`<i class="fa-solid fa-pencil" style="color:#f5a623;"></i> –ú–∞–ª—é–Ω–∫–∏`] = drawingsLayer
            mapLayersControl = L.control.layers(baseLayers, overlayMaps, { collapsed: false });
            mapLayersControl.addTo(map);
            document.getElementById('layers-container').appendChild(mapLayersControl.getContainer());
            Object.values(fileLayerGroups).forEach(group => map.addLayer(group));
            if (intersectionClusterGroup) map.addLayer(intersectionClusterGroup);
        }
        
        function drawObservation(log, layerGroup, isOverlay = false) {
            const originPoint = [log.originCoordinates.lat, log.originCoordinates.lon];
            const averageAzimuth = (parseAzimuth(log.azimuth)[0] + parseAzimuth(log.azimuth)[1]) / 2;
            const targetPoint = getDestPoint(originPoint[0], originPoint[1], averageAzimuth, log.distance);
            const polyline = L.polyline([originPoint, targetPoint], { color: log.fileColor, weight: 3, opacity: 0.9 }).addTo(layerGroup);
            const marker = L.circle(targetPoint, { color: log.fileColor, fillColor: log.fileColor, fillOpacity: 0.4, radius: 25 }).addTo(layerGroup);
            if (!isOverlay) {
                // marker.bindPopup(`<b>${log.name}</b><br><b>–î–∏—Å—Ç:</b> ${log.distance} –º`);
                 marker.on('click', () => { // –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –û–ë–†–ê–ë–û–¢–ß–ò–ö
                    openEventModal(log, targetPoint);
            });
                mapFeatures[log.uniqueId] = { marker, polyline };
            }
        }
        
        function filterForIntersection(logs) { return logs.filter(log => { if (!log.name || !log.azimuth || !log.distance) return false; const [startAz, endAz] = parseAzimuth(log.azimuth); return (endAz - startAz) <= 10; }); }
        function calculateAndDrawIntersections(logs) {
            intersectionClusterGroup = L.markerClusterGroup();
            for (let i = 0; i < logs.length; i++) { for (let j = i + 1; j < logs.length; j++) {
                const logA = logs[i], logB = logs[j]; if (logA.originCoordinates.lat === logB.originCoordinates.lat && logA.originCoordinates.lon === logB.originCoordinates.lon) continue;
                const iPoint = findIntersection(logA, logB);
                if (iPoint) {
                    const distA = calculateDistance(logA.originCoordinates.lat, logA.originCoordinates.lon, iPoint[0], iPoint[1]); const distB = calculateDistance(logB.originCoordinates.lat, logB.originCoordinates.lon, iPoint[0], iPoint[1]);
                    const popup = `<b>–ü–µ—Ä–µ—Ç–∏–Ω</b><br><b>–ö–æ–æ—Ä–¥:</b> ${iPoint[0].toFixed(5)}, ${iPoint[1].toFixed(5)}<hr><b>–§–∞–π–ª 1:</b> ${logA.fileName}<br><b>–î–∏—Å—Ç:</b> ${Math.round(distA)} –º<br><hr><b>–§–∞–π–ª 2:</b> ${logB.fileName}<br><b>–î–∏—Å—Ç:</b> ${Math.round(distB)} –º`;
                    const marker = L.marker(iPoint, { icon: L.divIcon({ className: 'fa-solid fa-crosshairs intersection-icon', iconSize: [24, 24] }) }).bindPopup(popup);
                    marker.feature = { type: "Feature", geometry: { type: "Point", coordinates: [iPoint[1], iPoint[0]] }, properties: { file1: logA.fileName, dist1: Math.round(distA), file2: logB.fileName, dist2: Math.round(distB) } };
                    intersectionClusterGroup.addLayer(marker);
                }
            }}
        }
        document.getElementById('export-button').addEventListener('click', () => {
            const layersToExport = [ ...Object.values(fileLayerGroups).flatMap(lg => lg.getLayers()), ...(intersectionClusterGroup ? intersectionClusterGroup.getLayers() : []), ...customPointsLayer.getLayers() ];
            if (layersToExport.length === 0) { return alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É."); }
            const featureGroup = L.featureGroup(layersToExport); const geoJson = featureGroup.toGeoJSON();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geoJson, null, 2)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "map_data.geojson"); document.body.appendChild(dl); dl.click(); dl.remove();
        });
        function generateHslColor(index, total) { const hue = (index * (360 / total)) % 360; return `hsl(${hue}, 70%, 50%)`; }
        function parseAzimuth(az) { if (typeof az === 'string' && az.includes('-')) return az.split('-').map(Number); return [Number(az), Number(az)]; }
        function getDestPoint(lat, lon, brng, dist) { const R = 6371e3; const l1 = lat * Math.PI / 180, n1 = lon * Math.PI / 180, b = brng * Math.PI / 180; const l2 = Math.asin(Math.sin(l1) * Math.cos(dist / R) + Math.cos(l1) * Math.sin(dist / R) * Math.cos(b)); const n2 = n1 + Math.atan2(Math.sin(b) * Math.sin(dist / R) * Math.cos(l1), Math.cos(dist / R) - Math.sin(l1) * Math.sin(l2)); return [l2 * 180 / Math.PI, n2 * 180 / Math.PI]; }
        function findIntersection(logA, logB) { const azA = (parseAzimuth(logA.azimuth)[0] + parseAzimuth(logA.azimuth)[1]) / 2; const azB = (parseAzimuth(logB.azimuth)[0] + parseAzimuth(logB.azimuth)[1]) / 2; const p1 = logA.originCoordinates, p3 = logB.originCoordinates; const p2 = getDestPoint(p1.lat, p1.lon, azA, 10000), p4 = getDestPoint(p3.lat, p3.lon, azB, 10000); const x1 = p1.lon, y1 = p1.lat, x2 = p2[1], y2 = p2[0], x3 = p3.lon, y3 = p3.lat, x4 = p4[1], y4 = p4[0]; const den = (x1 - x2) * (y3 - y4) - (y1 - y2) * (x3 - x4); if (den === 0) return null; const t = ((x1 - x3) * (y3 - y4) - (y1 - y3) * (x3 - x4)) / den; const u = -((x1 - x2) * (y1 - y3) - (y1 - y2) * (x1 - x3)) / den; if (t > 0 && u > 0) return [y1 + t * (y2 - y1), x1 + t * (x2 - x1)]; return null; }
        function calculateDistance(lat1, lon1, lat2, lon2) { const R = 6371e3; const p1 = lat1 * Math.PI / 180, p2 = lat2 * Math.PI / 180; const dP = (lat2 - lat1) * Math.PI / 180; const dL = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(dP / 2) * Math.sin(dP / 2) + Math.cos(p1) * Math.cos(p2) * Math.sin(dL / 2) * Math.sin(dL / 2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); return R * c; }

        // --- –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ ---
        window.addEventListener('load', () => {
            fetchDataFromSheet();
            setInterval(() => fetchDataFromSheet(true), 30000);
        });

        // --- –õ–û–ì–Ü–ö–ê –ú–û–î–ê–õ–¨–ù–û–ì–û –í–Ü–ö–ù–ê –¢–ê –†–ò–°–£–í–ê–ù–ù–Ø ---

const eventModalOverlay = document.getElementById('event-modal-overlay');

function openEventModal(log, coordinates) {
    currentModalLog = {log: log, coordinates: coordinates}; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–∫–Ω–æ –¥–∞–Ω–Ω—ã–º–∏
    document.getElementById('modal-title').textContent = log.name || '–î–µ—Ç–∞–ª—ñ –ø–æ–¥—ñ—ó';
    document.getElementById('modal-coords').textContent = `${coordinates[0].toFixed(5)}, ${coordinates[1].toFixed(5)}`;
    const eventDate = new Date(log.timestamp);
    document.getElementById('modal-datetime').textContent = eventDate.toLocaleString('uk-UA', { dateStyle: 'medium', timeStyle: 'short' });
    document.getElementById('modal-comment').textContent = log.comment || '–ù–µ–º–∞—î';

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ
    eventModalOverlay.classList.add('visible');
}

function closeModal() {
    eventModalOverlay.classList.remove('visible');
    currentModalLog = null;
    map.off('click'); // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    document.getElementById('map').classList.remove('map-placement-mode');
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞
document.getElementById('modal-close-button').addEventListener('click', closeModal);
eventModalOverlay.addEventListener('click', (e) => {
    if (e.target === eventModalOverlay) {
        closeModal();
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
document.getElementById('modal-draw-arrow').addEventListener('click', () => startDrawing('arrow'));
document.getElementById('modal-draw-line').addEventListener('click', () => startDrawing('line'));

function startDrawing(type) {
    if (!currentModalLog) return;
    
    eventModalOverlay.classList.remove('visible'); // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    document.getElementById('map').classList.add('map-placement-mode'); // –í–∫–ª—é—á–∞–µ–º –∫—É—Ä—Å–æ—Ä-–∫—Ä–µ—Å—Ç–∏–∫
    
    const startPoint = currentModalLog.coordinates;
    
    map.once('click', (e) => {
        const endPoint = e.latlng;
        const latlngs = [startPoint, [endPoint.lat, endPoint.lng]];
        
        let lineOptions = {
            color: currentModalLog.log.fileColor || '#ff0000',
            weight: 3
        };

        if (type === 'line') {
            lineOptions.dashArray = '5, 10'; // –®—Ç—Ä–∏—Ö-–ø—É–Ω–∫—Ç–∏—Ä–Ω–∞—è –ª–∏–Ω–∏—è
        }

        const polyline = L.polyline(latlngs, lineOptions).addTo(drawingsLayer);

        if (type === 'arrow') {
            L.polylineDecorator(polyline, {
                patterns: [
                    { offset: '100%', repeat: 0, symbol: L.Symbol.arrowHead({ pixelSize: 15, polygon: false, pathOptions: { stroke: true, color: lineOptions.color } }) }
                ]
            }).addTo(drawingsLayer);
        }
        
        document.getElementById('map').classList.remove('map-placement-mode');
        currentModalLog = null;
    });
}


// --- üñãÔ∏è –ù–û–í–ê –õ–û–ì–Ü–ö–ê –î–õ–Ø –ö–ù–û–ü–ö–ò "–î–û–î–ê–¢–ò –í–õ–ê–°–ù–£ –¢–û–ß–ö–£" ---

const customPointModal = document.getElementById('custom-point-modal-overlay');
const pointSourceRadios = document.querySelectorAll('input[name="point-icon-source"]');
const pointUrlGroup = document.getElementById('point-url-source-group');
const pointFileGroup = document.getElementById('point-file-source-group');

// –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
document.getElementById('custom-point-modal-close-button').addEventListener('click', () => customPointModal.classList.remove('visible'));
customPointModal.addEventListener('click', (e) => {
    if (e.target === customPointModal) customPointModal.classList.remove('visible');
});

// –ü–µ—Ä–µ–º–∏–∫–∞—á –¥–∂–µ—Ä–µ–ª–∞ —ñ–∫–æ–Ω–∫–∏ (–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ / URL / –§–∞–π–ª)
pointSourceRadios.forEach(radio => {
    radio.addEventListener('change', () => {
        const selected = document.querySelector('input[name="point-icon-source"]:checked').value;
        pointUrlGroup.style.display = selected === 'url' ? 'block' : 'none';
        pointFileGroup.style.display = selected === 'file' ? 'block' : 'none';
    });
});

// –û–±—Ä–æ–±–∫–∞ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ "–†–æ–∑–º—ñ—Å—Ç–∏—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç—ñ"
document.getElementById('place-point-submit').addEventListener('click', () => {
    const name = document.getElementById('point-name-input').value.trim() || "–ë–µ–∑ –Ω–∞–∑–≤–∏";
    const sourceType = document.querySelector('input[name="point-icon-source"]:checked').value;

    let iconPromise;

    switch (sourceType) {
        case 'url':
            const url = document.getElementById('point-url-input').value.trim();
            if (!url) { alert('–í—Å—Ç–∞–≤—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —ñ–∫–æ–Ω–∫—É.'); return; }
            iconPromise = Promise.resolve(createCustomIcon(url));
            break;
        case 'file':
            const file = document.getElementById('point-file-input').files[0];
            if (!file) { alert('–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª —ñ–∫–æ–Ω–∫–∏.'); return; }
            iconPromise = new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(createCustomIcon(e.target.result));
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
            break;
        default: // 'default'
            // –°—Ç–≤–æ—Ä—é—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —ñ–∫–æ–Ω–∫—É, —è–∫ –±—É–ª–∞ —Ä–∞–Ω—ñ—à–µ
            const defaultIcon = L.divIcon({
                className: 'fa-solid fa-map-pin',
                iconSize: [24, 24],
                html: `<i class="fa-solid fa-map-pin" style="font-size: 24px; color: var(--accent-color); text-shadow: 0 0 3px rgba(0,0,0,0.5);"></i>`
            });
            iconPromise = Promise.resolve(defaultIcon);
    }

    iconPromise.then(icon => {
        startMarkerPlacement(name, icon);
    }).catch(err => {
        console.error("–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–∫–æ–Ω–∫–∏:", err);
        alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ–∫–æ–Ω–∫—É.");
    });
});

// –§—É–Ω–∫—Ü—ñ—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è L.icon –∑ –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–∏–º —Ä–æ–∑–º—ñ—Ä–æ–º
function createCustomIcon(url) {
    return L.icon({
        iconUrl: url,
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    });
}

// –§—É–Ω–∫—Ü—ñ—è, —â–æ –∞–∫—Ç–∏–≤—É—î —Ä–µ–∂–∏–º —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è –Ω–∞ –∫–∞—Ä—Ç—ñ
function startMarkerPlacement(name, icon) {
    customPointModal.classList.remove('visible');
    document.getElementById('map').classList.add('map-placement-mode');

    map.once('click', (e) => {
        const latlng = e.latlng;
        const marker = L.marker(latlng, { icon: icon, draggable: true }).addTo(customPointsLayer);

        const timestamp = new Date();
        const popupContent = `
            <b>${name}</b><hr style="margin: 5px 0;">
            <b>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏:</b><br>${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}<br>
            <b>–î–∞—Ç–∞:</b> ${timestamp.toLocaleDateString('uk-UA')}<br>
            <b>–ß–∞—Å:</b> ${timestamp.toLocaleTimeString('uk-UA')}
        `;

        marker.bindPopup(popupContent).openPopup();

        // –û—á–∏—â—É—î–º–æ –ø–æ–ª—è –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ä–∞–∑—É
        document.getElementById('point-name-input').value = '';
        document.getElementById('point-url-input').value = '';
        document.getElementById('point-file-input').value = null;

        document.getElementById('map').classList.remove('map-placement-mode');
    });
}

        
    </script>
</body>
</html>





